{
	"name": "EHS_PREPARATION",
	"properties": {
		"folder": {
			"name": "PREPARATION ECOULEMENT"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "EHS",
						"type": "DatasetReference"
					},
					"name": "EHS"
				},
				{
					"dataset": {
						"referenceName": "OrganisationEHS",
						"type": "DatasetReference"
					},
					"name": "OrganisationEHS"
				},
				{
					"dataset": {
						"referenceName": "VENTES_DIRECTES_PREPARED",
						"type": "DatasetReference"
					},
					"name": "VenteDirecte"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "outTempData",
						"type": "DatasetReference"
					},
					"name": "SoriteEHS"
				},
				{
					"dataset": {
						"referenceName": "outErrorFinding",
						"type": "DatasetReference"
					},
					"name": "EHSOrganisationNotfound"
				}
			],
			"transformations": [
				{
					"name": "ddimplement",
					"flowlet": {
						"referenceName": "decrementationVenteDirecte",
						"type": "DataFlowReference"
					}
				},
				{
					"name": "ExtractMonthYear"
				},
				{
					"name": "FiltrerCIA"
				},
				{
					"name": "FiltreCPCoop"
				},
				{
					"name": "UniqueCpCoopHubsApid"
				},
				{
					"name": "InnerJoinCIACPCoop"
				},
				{
					"name": "JoinLeftCIACPCoop"
				},
				{
					"name": "JoinVenteDirect"
				},
				{
					"name": "QuantiteesLivres"
				},
				{
					"name": "Rename"
				},
				{
					"name": "distributeur"
				},
				{
					"name": "RenamePOSSAMIDstring"
				},
				{
					"name": "RenameMarqueFile"
				},
				{
					"name": "dropDuplicatedColumn"
				},
				{
					"name": "select1"
				},
				{
					"name": "idDecrementation"
				},
				{
					"name": "select2"
				},
				{
					"name": "derivedColumn1"
				},
				{
					"name": "endDecrementation"
				},
				{
					"name": "join1"
				},
				{
					"name": "derivedColumn2"
				},
				{
					"name": "select3"
				},
				{
					"name": "leftjoin"
				},
				{
					"name": "filter1"
				},
				{
					"name": "union1"
				},
				{
					"name": "endNoDecrementation"
				},
				{
					"name": "derivedColumn3"
				},
				{
					"name": "aggregate1"
				},
				{
					"name": "filter2"
				}
			],
			"script": "source(output(\n\t\tMarques as string,\n\t\t{Région} as string,\n\t\t{Nom Agence} as string,\n\t\tCIA as string,\n\t\t{Département} as string,\n\t\t{Référence Article} as string,\n\t\t{Description Article} as string,\n\t\t{Catégorie Achat} as string,\n\t\t{Quantitées livrées} as string,\n\t\tyear as string,\n\t\tmonth as string,\n\t\t{Marques/ Constructeur} as string,\n\t\t{Gestion entrepôt} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> EHS\nsource(output(\n\t\t{Nom Coopérative} as string,\n\t\t{CP Coop.} as string,\n\t\tPOSSAMid as string,\n\t\tHubSAPid as string,\n\t\tBrandID as string,\n\t\tDept as string,\n\t\t{Code Postal} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> OrganisationEHS\nsource(output(\n\t\tyear as string,\n\t\treference as string,\n\t\t{Code client} as string,\n\t\tqte_ecoulement as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> VenteDirecte\nselect3 compose(mapColumn(\n\t\tid = idDecrementation,\n\t\tPossAMid = POSSAMid,\n\t\treference = {Référence Article},\n\t\tyear,\n\t\tmonth,\n\t\tqte_ecoulement = {Quantitées livrées},\n\t\tqte_venteDirecte = {Qté vente directe}\n\t),\n\tcomposition: 'decrementationVenteDirecte') ~> ddimplement@(output1)\nEHS derive(yearmonth = year+month,\n\t\tMarques = iif(!isNull(Marques), upper(Marques), upper({Marques/ Constructeur}))) ~> ExtractMonthYear\nderivedColumn2 filter(!isNull(CIA)) ~> FiltrerCIA\nOrganisationEHS filter(!isNull({CP Coop.})) ~> FiltreCPCoop\nFiltreCPCoop aggregate(groupBy({CP Coop.},\n\t\tHubSAPid),\n\t{Nom Coopérative} = max({Nom Coopérative}),\n\t\tPOSSAMid = max(POSSAMid),\n\t\tBrandID = max(BrandID),\n\t\tDept = max(Dept),\n\t\t{Code Postal} = max({Code Postal})) ~> UniqueCpCoopHubsApid\nFiltrerCIA, UniqueCpCoopHubsApid join(CIA == {CP Coop.},\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> InnerJoinCIACPCoop\nFiltrerCIA, UniqueCpCoopHubsApid join(CIA == {CP Coop.},\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinLeftCIACPCoop\nInnerJoinCIACPCoop, Rename join(coalesce(toString(toInteger(replace({Référence Article}, \" \", \"\"))),replace({Référence Article}, \" \", \"\")) == coalesce(toString(toInteger(replace(Article, \" \", \"\"))),replace(Article, \" \", \"\"))\n\t&& dropDuplicatedColumn@year == Rename@year\n\t&& POSSAMid == {Code client},\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinVenteDirect\njoin1 derive({Quantitées livrées} = qt_final) ~> QuantiteesLivres\nVenteDirecte select(mapColumn(\n\t\tyear,\n\t\tArticle = reference,\n\t\t{Code client},\n\t\t{Qté vente directe} = qte_ecoulement\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Rename\nunion1 derive(distributeur = \"EHS\",\n\t\tMarques = coalesce(Marques , {Marques/ Constructeur}),\n\t\treference = replace( replace({Référence Article}, 'SDU', ''),\"VAI\",\"\")) ~> distributeur\ndistributeur select(mapColumn(\n\t\tmarque_str = Marques,\n\t\t{Région},\n\t\t{Nom Agence},\n\t\tagence_code = CIA,\n\t\t{Département},\n\t\t{Référence Article},\n\t\t{Description Article},\n\t\t{Catégorie Achat},\n\t\tqte_ecoulement = {Quantitées livrées},\n\t\tyear,\n\t\t{Gestion entrepôt},\n\t\tmonth,\n\t\tyearmonth,\n\t\t{CP Coop.},\n\t\tHubSAPid,\n\t\t{Nom Coopérative},\n\t\tPOSSAMidString = POSSAMid,\n\t\tBrandID,\n\t\tDept,\n\t\t{Code postal} = {Code Postal},\n\t\tyearmonth = year,\n\t\tArticle,\n\t\t{Code client},\n\t\t{Qté vente directe},\n\t\treference,\n\t\tdistributeur\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> RenamePOSSAMIDstring\nRenamePOSSAMIDstring select(mapColumn(\n\t\tmarque_file = marque_str,\n\t\t{Région},\n\t\t{Nom Agence},\n\t\tagence_code,\n\t\t{Département},\n\t\t{Référence Article},\n\t\t{Description Article},\n\t\t{Catégorie Achat},\n\t\tqte_ecoulement,\n\t\tyear,\n\t\t{Gestion entrepôt},\n\t\tmonth,\n\t\tyearmonth,\n\t\t{CP Coop.},\n\t\tHubSAPid,\n\t\t{Nom Coopérative},\n\t\tPOSSAMidString,\n\t\tBrandID,\n\t\tDept,\n\t\t{Code postal},\n\t\tArticle,\n\t\t{Code client},\n\t\t{Qté vente directe},\n\t\treference,\n\t\tdistributeur\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> RenameMarqueFile\nExtractMonthYear select(mapColumn(\n\t\tMarques,\n\t\t{Région},\n\t\t{Nom Agence},\n\t\tCIA,\n\t\t{Département},\n\t\t{Référence Article},\n\t\t{Description Article},\n\t\t{Catégorie Achat},\n\t\t{Quantitées livrées},\n\t\tyear,\n\t\tmonth,\n\t\t{Gestion entrepôt},\n\t\t{Marques/ Constructeur},\n\t\tyearmonth\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> dropDuplicatedColumn\nJoinVenteDirect select(mapColumn(\n\t\tMarques,\n\t\t{Région},\n\t\t{Nom Agence},\n\t\tCIA,\n\t\t{Département},\n\t\t{Référence Article},\n\t\t{Description Article},\n\t\t{Catégorie Achat},\n\t\t{Quantitées livrées},\n\t\tyear = dropDuplicatedColumn@year,\n\t\tmonth,\n\t\t{Gestion entrepôt},\n\t\t{Marques/ Constructeur},\n\t\tyearmonth,\n\t\t{CP Coop.},\n\t\tHubSAPid,\n\t\t{Nom Coopérative},\n\t\tPOSSAMid,\n\t\tBrandID,\n\t\tDept,\n\t\t{Code Postal},\n\t\tArticle,\n\t\t{Code client},\n\t\t{Qté vente directe}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select1\nselect1 keyGenerate(output(idDecrementation as long),\n\tstartAt: 1L,\n\tstepValue: 1L) ~> idDecrementation\nidDecrementation select(mapColumn(\n\t\tidDecrementation,\n\t\tPOSSAMid,\n\t\t{Référence Article},\n\t\tyear,\n\t\tmonth,\n\t\t{Quantitées livrées},\n\t\t{Qté vente directe}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select2\nselect2 derive({Quantitées livrées} = toFloat({Quantitées livrées}),\n\t\t{Qté vente directe} = toFloat({Qté vente directe}),\n\t\tmonth = toInteger(month)) ~> derivedColumn1\nddimplement@output1 select(mapColumn(\n\t\tid_ = id,\n\t\tqt_final\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> endDecrementation\nidDecrementation, endDecrementation join(idDecrementation == id_,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> join1\ndropDuplicatedColumn derive({Référence Article} = replace( replace({Référence Article}, 'SDU', ''),\"VAI\",\"\")) ~> derivedColumn2\nderivedColumn1 select(mapColumn(\n\t\tidDecrementation,\n\t\tPOSSAMid,\n\t\t{Référence Article},\n\t\tyear,\n\t\tmonth,\n\t\t{Quantitées livrées},\n\t\t{Qté vente directe}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select3\nInnerJoinCIACPCoop, Rename join(coalesce(toString(toInteger(replace({Référence Article}, \" \", \"\"))),replace({Référence Article}, \" \", \"\")) == coalesce(toString(toInteger(replace(Article, \" \", \"\"))),replace(Article, \" \", \"\"))\n\t&& dropDuplicatedColumn@year == Rename@year\n\t&& POSSAMid == {Code client},\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> leftjoin\nleftjoin filter(isNull({Qté vente directe})) ~> filter1\nQuantiteesLivres, endNoDecrementation union(byName: true)~> union1\nderivedColumn3 select(mapColumn(\n\t\tMarques,\n\t\t{Région},\n\t\t{Nom Agence},\n\t\tCIA,\n\t\t{Département},\n\t\t{Référence Article},\n\t\t{Description Article},\n\t\t{Catégorie Achat},\n\t\t{Quantitées livrées},\n\t\tyear = dropDuplicatedColumn@year,\n\t\tmonth,\n\t\t{Gestion entrepôt},\n\t\t{Marques/ Constructeur},\n\t\tyearmonth,\n\t\t{CP Coop.},\n\t\tHubSAPid,\n\t\t{Nom Coopérative},\n\t\tPOSSAMid,\n\t\tBrandID,\n\t\tDept,\n\t\t{Code Postal},\n\t\tArticle,\n\t\t{Code client},\n\t\t{Qté vente directe}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> endNoDecrementation\nfilter1 derive({Quantitées livrées} = toInteger({Quantitées livrées})) ~> derivedColumn3\nRenameMarqueFile aggregate(groupBy(marque_file,\n\t\t{Nom Agence},\n\t\tagence_code,\n\t\t{Référence Article},\n\t\tyear,\n\t\tmonth,\n\t\tyearmonth,\n\t\t{CP Coop.},\n\t\tHubSAPid,\n\t\t{Nom Coopérative},\n\t\tPOSSAMidString,\n\t\treference,\n\t\tdistributeur),\n\tqte_ecoulement = sum(qte_ecoulement),\n\t\t{Description Article} = max({Description Article})) ~> aggregate1\naggregate1 filter({CP Coop.}==\"112\"&&reference==\"0010021497\" &&yearmonth==\"202101\") ~> filter2\naggregate1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tOrg_commerciale as string,\n\t\t{Canal distribution} as string,\n\t\t{Secteur d'activit�} as string,\n\t\t{Document de vente} as string,\n\t\tPoste as string,\n\t\t{Jour calendaire} as string,\n\t\t{Agence commerciale corrig�} as string,\n\t\t{ATC Corrig�} as string,\n\t\t{Donneur d'ordre} as string,\n\t\t{Recept de march} as string,\n\t\t{Destinataire facture} as string,\n\t\t{Type doc vente} as string,\n\t\t{Type de poste} as string,\n\t\tLivraison as string,\n\t\t{Type de livraison} as string,\n\t\t{Type poste Livraison} as string,\n\t\tFacture as string,\n\t\t{Type de facture} as string,\n\t\t{Type poste Facture} as string,\n\t\t{Mois calendrier} as string,\n\t\t{Ann�e civile} as string,\n\t\t{Motif commande} as string,\n\t\t{CA cd�} as string,\n\t\t{Qt� livr�e} as string,\n\t\t{CA livr�} as string,\n\t\t{Qt� factur�e} as string,\n\t\t{CA factur�} as string,\n\t\t{Cout standard cd�} as string,\n\t\t{Cout fabrication} as string,\n\t\t{Cout standard livr�} as string,\n\t\t{Cout standard factur�} as string,\n\t\tdate_id as string,\n\t\tyear as string,\n\t\tyearmonth as string,\n\t\tqt_cd_e as string,\n\t\tca_cd_ as string,\n\t\tqt_factur_e as string,\n\t\tca_factur_ as string,\n\t\treference as string,\n\t\tWholeSalerID as string,\n\t\tWholeSalerHubID as string,\n\t\tHubName as string,\n\t\t{P�riode} as string,\n\t\tOffre as string,\n\t\tmonth as string,\n\t\tqte_ecoulement as string,\n\t\tPOSSAMidString as string,\n\t\tHubSAPid as string,\n\t\tdistributeur as string,\n\t\tagence_code as string,\n\t\tmarque as string,\n\t\t{Code postal} as string,\n\t\tmarque_name as string,\n\t\tqte_ecc as string,\n\t\tca_ecoulement as string,\n\t\tdata_origin as string,\n\t\t{Ecoulement origin} as string,\n\t\tcanal_final as string,\n\t\t{ATC performance} as string,\n\t\tCanal as string\n\t),\n\tpartitionFileNames:['SortieEcoulementEHS.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> SoriteEHS\nJoinLeftCIACPCoop sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\t{Marque DESC} as string,\n\t\t{Marque Code} as string,\n\t\t{Sous Famille} as string,\n\t\t{Référence Article Fournisseur} as string,\n\t\t{Agence Code} as string,\n\t\t{Département ID} as string,\n\t\t{Quantité en UV BL} as string,\n\t\tyearmonth as string,\n\t\tyear as string,\n\t\tmonth as string,\n\t\tPOSid as string,\n\t\tWholeSalerID as string,\n\t\tPOSSAMidString as string,\n\t\tHubSAPid as string,\n\t\tBrandID as string\n\t),\n\tpartitionFileNames:['EHSOrganisationNotfound.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> EHSOrganisationNotfound"
		}
	}
}