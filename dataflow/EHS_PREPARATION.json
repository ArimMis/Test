{
	"name": "EHS_PREPARATION",
	"properties": {
		"folder": {
			"name": "PREPARATION ECOULEMENT"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "EHS",
						"type": "DatasetReference"
					},
					"name": "EHS"
				},
				{
					"dataset": {
						"referenceName": "OrganisationEHS",
						"type": "DatasetReference"
					},
					"name": "OrganisationEHS"
				},
				{
					"dataset": {
						"referenceName": "VENTES_DIRECTES_PREPARED",
						"type": "DatasetReference"
					},
					"name": "VenteDirecte"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "SortieEHS",
						"type": "DatasetReference"
					},
					"name": "SoriteEHS"
				},
				{
					"dataset": {
						"referenceName": "EHSOrganiationNotfound",
						"type": "DatasetReference"
					},
					"name": "EHSOrganisationNotfound"
				}
			],
			"transformations": [
				{
					"name": "ddimplement",
					"flowlet": {
						"referenceName": "decrementationVenteDirecte",
						"type": "DataFlowReference"
					}
				},
				{
					"name": "ExtractMonthYear"
				},
				{
					"name": "FiltrerCIA"
				},
				{
					"name": "FiltreCPCoop"
				},
				{
					"name": "UniqueCpCoopHubsApid"
				},
				{
					"name": "InnerJoinCIACPCoop"
				},
				{
					"name": "JoinLeftCIACPCoop"
				},
				{
					"name": "JoinVenteDirect"
				},
				{
					"name": "QuantiteesLivres"
				},
				{
					"name": "Rename"
				},
				{
					"name": "distributeur"
				},
				{
					"name": "RenamePOSSAMIDstring"
				},
				{
					"name": "RenameMarqueFile"
				},
				{
					"name": "dropDuplicatedColumn"
				},
				{
					"name": "select1"
				},
				{
					"name": "idDecrementation"
				},
				{
					"name": "select2"
				},
				{
					"name": "derivedColumn1"
				},
				{
					"name": "endDecrementation"
				},
				{
					"name": "join1"
				},
				{
					"name": "derivedColumn2"
				},
				{
					"name": "select3"
				}
			],
			"script": "source(output(\n\t\tMarques as string,\n\t\t{Région} as string,\n\t\t{Nom Agence} as string,\n\t\tCIA as string,\n\t\t{Département} as string,\n\t\t{Référence Article} as string,\n\t\t{Description Article} as string,\n\t\t{Catégorie Achat} as string,\n\t\t{Quantitées livrées} as string,\n\t\tyear as string,\n\t\tmonth as string,\n\t\t{Marques/ Constructeur} as string,\n\t\t{Gestion entrepôt} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> EHS\nsource(output(\n\t\t{Nom Coopérative} as string,\n\t\t{CP Coop.} as string,\n\t\tPOSSAMid as string,\n\t\tHubSAPid as string,\n\t\tBrandID as string,\n\t\tDept as string,\n\t\t{Code Postal} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> OrganisationEHS\nsource(output(\n\t\tyear as string,\n\t\treference as string,\n\t\t{Code client} as string,\n\t\tqte_ecoulement as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> VenteDirecte\nselect3 compose(mapColumn(\n\t\tid,\n\t\tPossAMid = id,\n\t\treference = id,\n\t\tyear,\n\t\tmonth,\n\t\tqte_ecoulement = id,\n\t\tqte_venteDirecte = id\n\t),\n\tcomposition: 'decrementationVenteDirecte') ~> ddimplement@(output1)\nEHS derive(yearmonth = year+month,\n\t\tMarques = iif(!isNull(Marques), upper(Marques), upper({Marques/ Constructeur}))) ~> ExtractMonthYear\nderivedColumn2 filter(!isNull(CIA)) ~> FiltrerCIA\nOrganisationEHS filter(!isNull({CP Coop.})) ~> FiltreCPCoop\nFiltreCPCoop aggregate(groupBy({CP Coop.},\n\t\tHubSAPid),\n\t{Nom Coopérative} = max({Nom Coopérative}),\n\t\tPOSSAMid = max(POSSAMid),\n\t\tBrandID = max(BrandID),\n\t\tDept = max(Dept),\n\t\t{Code Postal} = max({Code Postal})) ~> UniqueCpCoopHubsApid\nFiltrerCIA, UniqueCpCoopHubsApid join(CIA == {CP Coop.},\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> InnerJoinCIACPCoop\nFiltrerCIA, UniqueCpCoopHubsApid join(CIA == {CP Coop.},\n\tjoinType:'left',\n\tbroadcast: 'auto')~> JoinLeftCIACPCoop\nInnerJoinCIACPCoop, Rename join(coalesce(toString(toInteger(replace({Référence Article}, \" \", \"\"))),replace({Référence Article}, \" \", \"\")) == coalesce(toString(toInteger(replace(Article, \" \", \"\"))),replace(Article, \" \", \"\"))\n\t&& dropDuplicatedColumn@year == Rename@year\n\t&& POSSAMid == {Code client},\n\tjoinType:'left',\n\tbroadcast: 'auto')~> JoinVenteDirect\njoin1 derive({Quantitées livrées} = qt_final) ~> QuantiteesLivres\nVenteDirecte select(mapColumn(\n\t\tyear,\n\t\tArticle = reference,\n\t\t{Code client},\n\t\t{Qté vente directe} = qte_ecoulement\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Rename\nQuantiteesLivres derive(distributeur = \"EHS\",\n\t\tMarques = coalesce(Marques , {Marques/ Constructeur}),\n\t\treference = replace({Référence Article}, 'SDU', '')) ~> distributeur\ndistributeur select(mapColumn(\n\t\tmarque_str = Marques,\n\t\t{Région},\n\t\t{Nom Agence},\n\t\tagence_code = CIA,\n\t\t{Département},\n\t\t{Référence Article},\n\t\t{Description Article},\n\t\t{Catégorie Achat},\n\t\tqte_ecoulement = {Quantitées livrées},\n\t\tyear,\n\t\t{Gestion entrepôt},\n\t\tmonth,\n\t\tyearmonth,\n\t\t{CP Coop.},\n\t\tHubSAPid,\n\t\t{Nom Coopérative},\n\t\tPOSSAMidString = POSSAMid,\n\t\tBrandID,\n\t\tDept,\n\t\t{Code postal} = {Code Postal},\n\t\tyearmonth = year,\n\t\tArticle,\n\t\t{Code client},\n\t\t{Qté vente directe},\n\t\treference,\n\t\tdistributeur\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> RenamePOSSAMIDstring\nRenamePOSSAMIDstring select(mapColumn(\n\t\tmarque_file = marque_str,\n\t\t{Région},\n\t\t{Nom Agence},\n\t\tagence_code,\n\t\t{Département},\n\t\t{Référence Article},\n\t\t{Description Article},\n\t\t{Catégorie Achat},\n\t\tqte_ecoulement,\n\t\tyear,\n\t\t{Gestion entrepôt},\n\t\tmonth,\n\t\tyearmonth,\n\t\t{CP Coop.},\n\t\tHubSAPid,\n\t\t{Nom Coopérative},\n\t\tPOSSAMidString,\n\t\tBrandID,\n\t\tDept,\n\t\t{Code postal},\n\t\tArticle,\n\t\t{Code client},\n\t\t{Qté vente directe},\n\t\treference,\n\t\tdistributeur\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> RenameMarqueFile\nExtractMonthYear select(mapColumn(\n\t\tMarques,\n\t\t{Région},\n\t\t{Nom Agence},\n\t\tCIA,\n\t\t{Département},\n\t\t{Référence Article},\n\t\t{Description Article},\n\t\t{Catégorie Achat},\n\t\t{Quantitées livrées},\n\t\tyear,\n\t\tmonth,\n\t\t{Gestion entrepôt},\n\t\t{Marques/ Constructeur},\n\t\tyearmonth\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> dropDuplicatedColumn\nJoinVenteDirect select(mapColumn(\n\t\tMarques,\n\t\t{Région},\n\t\t{Nom Agence},\n\t\tCIA,\n\t\t{Département},\n\t\t{Référence Article},\n\t\t{Description Article},\n\t\t{Catégorie Achat},\n\t\t{Quantitées livrées},\n\t\tyear = dropDuplicatedColumn@year,\n\t\tmonth,\n\t\t{Gestion entrepôt},\n\t\t{Marques/ Constructeur},\n\t\tyearmonth,\n\t\t{CP Coop.},\n\t\tHubSAPid,\n\t\t{Nom Coopérative},\n\t\tPOSSAMid,\n\t\tBrandID,\n\t\tDept,\n\t\t{Code Postal},\n\t\tArticle,\n\t\t{Code client},\n\t\t{Qté vente directe}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select1\nselect1 keyGenerate(output(idDecrementation as long),\n\tstartAt: 1L,\n\tstepValue: 1L) ~> idDecrementation\nidDecrementation select(mapColumn(\n\t\tidDecrementation,\n\t\tPOSSAMid,\n\t\t{Référence Article},\n\t\tyear,\n\t\tmonth,\n\t\t{Quantitées livrées},\n\t\t{Qté vente directe}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select2\nselect2 derive({Quantitées livrées} = toFloat({Quantitées livrées}),\n\t\t{Qté vente directe} = toFloat({Qté vente directe}),\n\t\tmonth = toInteger(month)) ~> derivedColumn1\nddimplement@output1 select(mapColumn(\n\t\tid,\n\t\tqt_final\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> endDecrementation\nidDecrementation, endDecrementation join(idDecrementation == id,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> join1\ndropDuplicatedColumn derive({Référence Article} = replace({Référence Article}, 'SDU', '')) ~> derivedColumn2\nderivedColumn1 select(mapColumn(\n\t\tidDecrementation,\n\t\tPOSSAMid,\n\t\t{Référence Article},\n\t\tyear,\n\t\tmonth,\n\t\t{Quantitées livrées},\n\t\t{Qté vente directe}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select3\nRenameMarqueFile sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tyearmonth as string,\n\t\tyear as string,\n\t\tmonth as string,\n\t\tqte_ecoulement as string,\n\t\tca_ecoulement as string,\n\t\tPOSSAMidString as string,\n\t\tHubSAPid as string,\n\t\treference as string,\n\t\tdistributeur as string,\n\t\tagence_code as string,\n\t\tmarque as string,\n\t\t{Code postal} as string,\n\t\tmarque_name as string,\n\t\ttoreplicate as string,\n\t\tdd as string,\n\t\trcount as string,\n\t\tindexcols2 as string,\n\t\tqte_ecc as string\n\t),\n\tpartitionFileNames:['SortieEcoulementEHS.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> SoriteEHS\nJoinLeftCIACPCoop sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tyearmonth as string,\n\t\tyear as string,\n\t\tmonth as string,\n\t\tqte_ecoulement as string,\n\t\tca_ecoulement as string,\n\t\tPOSSAMidString as string,\n\t\tHubSAPid as string,\n\t\treference as string,\n\t\tdistributeur as string,\n\t\tagence_code as string,\n\t\tmarque as string,\n\t\t{Code postal} as string,\n\t\tmarque_name as string,\n\t\ttoreplicate as string,\n\t\tdd as string,\n\t\trcount as string,\n\t\tindexcols2 as string,\n\t\tqte_ecc as string\n\t),\n\tpartitionFileNames:['EHSOrganisationNotfound.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> EHSOrganisationNotfound"
		}
	}
}