{
	"name": "MAILLARD_PREPARATION",
	"properties": {
		"folder": {
			"name": "PREPARATION ECOULEMENT"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "MAILLARD_ECOULEMENT",
						"type": "DatasetReference"
					},
					"name": "ecoulement"
				},
				{
					"dataset": {
						"referenceName": "MAILLARD_ORGANISATION",
						"type": "DatasetReference"
					},
					"name": "organisation"
				},
				{
					"dataset": {
						"referenceName": "VENTES_DIRECTES_PREPARED",
						"type": "DatasetReference"
					},
					"name": "ventesDirectes"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "MAILLARD_ECOUL_PREPARED",
						"type": "DatasetReference"
					},
					"name": "MAILLARDECOULPREPARED"
				},
				{
					"dataset": {
						"referenceName": "MAILLARD_ORGANISATION_NOTFOUND",
						"type": "DatasetReference"
					},
					"name": "organisationNotFound"
				}
			],
			"transformations": [
				{
					"name": "quantityNotNull"
				},
				{
					"name": "getYear"
				},
				{
					"name": "yearMonth"
				},
				{
					"name": "depotNotNull"
				},
				{
					"name": "cleansing"
				},
				{
					"name": "notNull"
				},
				{
					"name": "uniqueAgenceAndHubsapID"
				},
				{
					"name": "innerOrganisation"
				},
				{
					"name": "leftOrganisation"
				},
				{
					"name": "outerleftOrganisation"
				},
				{
					"name": "cleansingVentesDirectes"
				},
				{
					"name": "sumQuantity"
				},
				{
					"name": "innerVentesDirectes"
				},
				{
					"name": "typeCaste"
				},
				{
					"name": "leftVentesDirectes"
				},
				{
					"name": "outerleftVentesDirectes"
				},
				{
					"name": "enleverVentesDirectes"
				},
				{
					"name": "Rename"
				},
				{
					"name": "fullLeftUnion"
				},
				{
					"name": "marqueFile"
				},
				{
					"name": "uniformisation"
				},
				{
					"name": "yearmonthSplit"
				},
				{
					"name": "window1"
				},
				{
					"name": "select1"
				},
				{
					"name": "select2"
				},
				{
					"name": "MapDrifted2",
					"description": "Creates an explicit mapping for each drifted column"
				},
				{
					"name": "window2"
				},
				{
					"name": "derivedColumn1"
				}
			],
			"script": "source(output(\n\t\t{Société} as string,\n\t\t{Dépot} as string,\n\t\tMois as string,\n\t\t{Code GTAC} as string,\n\t\t{Référence} as string,\n\t\t{Désignation} as string,\n\t\t{Quantité} as string,\n\t\tValeur as string,\n\t\t{Quantité n-1} as string,\n\t\t{Valeur n-1} as string,\n\t\t{CP Dépôt} as string,\n\t\tDummy as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinferDriftedColumnTypes: true,\n\tignoreNoFilesFound: false,\n\trowUrlColumn: 'fname',\n\twildcardPaths:['Ecoulement/Maillard/*.csv']) ~> ecoulement\nsource(output(\n\t\t{Nom Agence (Code)} as string,\n\t\t{CP Agence} as string,\n\t\tPOSSAMid as string,\n\t\tHubSAPid as string,\n\t\tBrandID as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> organisation\nsource(output(\n\t\tyear as string,\n\t\treference as string,\n\t\t{Code client} as string,\n\t\tqte_ecoulement as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> ventesDirectes\nselect1 filter(!isNull({Quantité})) ~> quantityNotNull\nquantityNotNull derive(Year = split(Mois, \"/\")[2],\n\t\tMonth = split(Mois, \"/\")[1]) ~> getYear\ngetYear derive(Yearmonth = concat(Year, Month)) ~> yearMonth\nyearMonth filter(!isNull({Dépot})) ~> depotNotNull\norganisation derive({Nom Agence (Code)} = trim({Nom Agence (Code)}, \" \"),\n\t\tHubSAPid = trim({HubSAPid}, \" \")) ~> cleansing\ncleansing filter(!isNull({Nom Agence (Code)})) ~> notNull\nnotNull aggregate(groupBy({Nom Agence (Code)},\n\t\tHubSAPid),\n\t{CP Agence} = max({CP Agence}),\n\t\tPOSSAMid = max(POSSAMid),\n\t\tBrandID = max(BrandID)) ~> uniqueAgenceAndHubsapID\ndepotNotNull, uniqueAgenceAndHubsapID join({Dépot} == {Nom Agence (Code)},\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> innerOrganisation\ndepotNotNull, uniqueAgenceAndHubsapID join({Dépot} == {Nom Agence (Code)},\n\tjoinType:'left',\n\tbroadcast: 'auto')~> leftOrganisation\nleftOrganisation filter(isNull({Nom Agence (Code)})) ~> outerleftOrganisation\nventesDirectes derive({Code client} = trim({Code client}, \" \"),\n\t\t{Qté facturée} = toDouble(qte_ecoulement),\n\t\tyear = trim(year, \" \"),\n\t\tArticle = trim(reference, \" \")) ~> cleansingVentesDirectes\ncleansingVentesDirectes aggregate(groupBy(year,\n\t\tArticle,\n\t\t{Code client}),\n\t{Qté facturée} = sum({Qté facturée})) ~> sumQuantity\nwindow1, typeCaste join(getYear@Year == typeCaste@year\n\t&& coalesce(toString(toInteger(replace({Référence}, \" \", \"\"))),replace({Référence}, \" \", \"\")) == coalesce(toString(toInteger(replace(Article, \" \", \"\"))),replace(Article, \" \", \"\"))\n\t&& POSSAMid == {Code client},\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> innerVentesDirectes\nRename derive(year = toString(year),\n\t\tArticle = toString(Article),\n\t\t{Code client} = toString({Code client})) ~> typeCaste\nyearmonthSplit, typeCaste join(getYear@Year == typeCaste@year\n\t&& coalesce(toString(toInteger(replace({Référence}, \" \", \"\"))),replace({Référence}, \" \", \"\")) == coalesce(toString(toInteger(replace(Article, \" \", \"\"))),replace(Article, \" \", \"\"))\n\t&& POSSAMid == {Code client},\n\tjoinType:'left',\n\tbroadcast: 'auto')~> leftVentesDirectes\nleftVentesDirectes filter(isNull(typeCaste@year) || isNull(Article) || isNull({Code client})) ~> outerleftVentesDirectes\ninnerVentesDirectes derive(ecart = runingQte-{Qté ventes directes},\n\t\tsigne = iif(toDouble(runingQte)-toDouble({Qté ventes directes}) <=0 , 0, 1)) ~> enleverVentesDirectes\nsumQuantity select(mapColumn(\n\t\tyear,\n\t\tArticle,\n\t\t{Code client},\n\t\t{Qté ventes directes} = {Qté facturée}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Rename\nderivedColumn1, outerleftVentesDirectes union(byName: true)~> fullLeftUnion\nfullLeftUnion derive(marque_file = iif(toInteger(BrandID)==1604, \"saunier\", \"vaillant\"),\n\t\t{Société} = upper({Société})) ~> marqueFile\nmarqueFile select(mapColumn(\n\t\tdistributeur = {Société},\n\t\treference = {Référence},\n\t\tarticle = {Désignation},\n\t\tqte_ecoulement = {Quantité},\n\t\tca_ecoulement = Valeur,\n\t\t{Code postal} = {CP Dépôt},\n\t\tyear = fullLeftUnion@Year,\n\t\tmonth = Month,\n\t\tyearmonth = Yearmonth,\n\t\tHubSAPid,\n\t\tPOSSAMid,\n\t\tmarque_id = BrandID,\n\t\tmarque_file,\n\t\tagence_code = {Dépot}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> uniformisation\ninnerOrganisation derive(Yearmonth = replace(Yearmonth, \" \", \"\")) ~> yearmonthSplit\nyearmonthSplit window(over(Year,\n\t\tPOSSAMid,\n\t\t{Référence}),\n\tasc(Mois, true),\n\truningQte = sum({Quantité})) ~> window1\nselect2 select(mapColumn(\n\t\t{Société},\n\t\t{Dépot},\n\t\tMois,\n\t\t{Code GTAC},\n\t\t{Référence},\n\t\t{Désignation},\n\t\t{Quantité},\n\t\tValeur,\n\t\t{Quantité n-1},\n\t\t{Valeur n-1},\n\t\t{CP Dépôt},\n\t\tfname\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select1\nMapDrifted2 select(mapColumn(\n\t\t{Société} = Societe,\n\t\t{Dépot} = Dept,\n\t\tMois,\n\t\t{Code GTAC},\n\t\t{Référence} = Reference,\n\t\t{Désignation},\n\t\t{Quantité} = Qte,\n\t\tValeur,\n\t\t{Quantité n-1},\n\t\t{Valeur n-1},\n\t\t{CP Dépôt},\n\t\tDummy,\n\t\tfname\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select2\necoulement derive(Societe = toString(byName('SociÃ©tÃ©')),\n\t\tDept = toString(byName('DÃ©pot')),\n\t\tReference = toString(byName('RÃ©fÃ©rence')),\n\t\tDesignation = toString(byName('DÃ©signation')),\n\t\tQte = toShort(byName('QuantitÃ©'))) ~> MapDrifted2\nenleverVentesDirectes window(over(getYear@Year,\n\t\t{Référence},\n\t\tPOSSAMid),\n\tasc(Mois, true),\n\tsigne_cumul = sum(signe)) ~> window2\nwindow2 derive({Quantité} = iif( signe_cumul <1,0, iif (signe_cumul ==1 , toInteger(ecart), toInteger( {Quantité})   ) )) ~> derivedColumn1\nuniformisation sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\t{SaunierDuvalNicolas HERNANDEZ0100001999Conseiller Technique Thermodynamique0} as string,\n\t\t{SaunierDuvalNicolas HERNANDEZ0100001999Conseiller Technique Thermodynamique1} as string,\n\t\tSaunierDuval as string,\n\t\t{01000} as string,\n\t\t{01999} as string,\n\t\t{nicolas hernandez} as string,\n\t\t{Conseiller Technique Thermodynamique} as string,\n\t\t{01} as string,\n\t\t{1647-Rhône-Alpes Auvergne} as string,\n\t\t{16400092} as string,\n\t\t{nicolas julien} as string,\n\t\t{SD diffus} as string,\n\t\t{NICOLAS Julien} as string,\n\t\t{16566798} as string,\n\t\tProp_14 as string\n\t),\n\tpartitionFileNames:['MAILLARD_ECOUL_PREPARED.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> MAILLARDECOULPREPARED\nouterleftOrganisation sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tpartitionFileNames:['MAILLARD_ORGANISATION_NOTFOUND.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> organisationNotFound"
		}
	}
}