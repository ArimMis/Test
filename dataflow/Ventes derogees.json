{
	"name": "Ventes derogees",
	"properties": {
		"folder": {
			"name": "BASE COMMERCIALE"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "FacturationForOther",
						"type": "DatasetReference"
					},
					"name": "FacturationForOther"
				},
				{
					"dataset": {
						"referenceName": "associationoffre",
						"type": "DatasetReference"
					},
					"name": "ArticulationSap"
				},
				{
					"dataset": {
						"referenceName": "STG_OFFRE_SOURCE",
						"type": "DatasetReference"
					},
					"name": "stgOffre"
				},
				{
					"dataset": {
						"referenceName": "InPrixMoyenSplited",
						"type": "DatasetReference"
					},
					"name": "PrixPeriode"
				},
				{
					"dataset": {
						"referenceName": "ecouPartedisLikeWithIndex",
						"type": "DatasetReference"
					},
					"name": "ecoulmnt"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "SinkAvntJoinVenteDeroge",
						"type": "DatasetReference"
					},
					"name": "sink1"
				}
			],
			"transformations": [
				{
					"name": "filter1"
				},
				{
					"name": "join1"
				},
				{
					"name": "join2"
				},
				{
					"name": "Canal43"
				},
				{
					"name": "derivedColumn1"
				},
				{
					"name": "columnChoicePrix"
				},
				{
					"name": "join3"
				},
				{
					"name": "derivedColumn2"
				},
				{
					"name": "derivedColumn3"
				},
				{
					"name": "torolltoList"
				},
				{
					"name": "derivedColumn4"
				},
				{
					"name": "createIndexPartedis"
				},
				{
					"name": "derivedColumn5"
				},
				{
					"name": "select1"
				},
				{
					"name": "endEcoulement"
				},
				{
					"name": "select3"
				},
				{
					"name": "join4"
				},
				{
					"name": "filter2"
				},
				{
					"name": "join5"
				},
				{
					"name": "join6"
				}
			],
			"scriptLines": [
				"source(output(",
				"          { Org commerciale} as string,",
				"          {Canal distribution} as string,",
				"          {Secteur d'activité} as string,",
				"          {Document de vente} as string,",
				"          Poste as string,",
				"          {Jour calendaire} as string,",
				"          {1ereDateLivrDdee} as string,",
				"          {Agence commerciale corrigé} as string,",
				"          {ATC Corrigé} as string,",
				"          {Donneur d'ordre} as string,",
				"          {Recept de march} as string,",
				"          {Destinataire facture} as string,",
				"          {Type doc vente} as string,",
				"          {Type de poste} as string,",
				"          Livraison as string,",
				"          {Type de livraison} as string,",
				"          {Type poste Livraison} as string,",
				"          Facture as string,",
				"          {Type de facture} as string,",
				"          {Type poste Facture} as string,",
				"          {Mois calendrier} as string,",
				"          {Année civile} as string,",
				"          {Motif commande} as string,",
				"          {Qté cdée} as string,",
				"          {CA cdé} as string,",
				"          {Qté livrée} as string,",
				"          {CA livré} as string,",
				"          {Qté facturée} as string,",
				"          {CA facturé} as string,",
				"          {Cout standard cdé} as string,",
				"          {Cout fabrication} as string,",
				"          {Cout standard livré} as string,",
				"          {Cout standard facturé} as string,",
				"          date_id as string,",
				"          year as string,",
				"          yearmonth as string,",
				"          qt_cd_e as string,",
				"          ca_cd_ as string,",
				"          qt_livr_e as string,",
				"          ca_livr_ as string,",
				"          qt_factur_e as string,",
				"          ca_factur_ as string,",
				"          year_month as string,",
				"          reference as string,",
				"          WholeSalerID as string,",
				"          WholeSalerHubID as string,",
				"          HubName as string,",
				"          HubSAPid as string,",
				"          toreplicate as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     inferDriftedColumnTypes: true,",
				"     ignoreNoFilesFound: false) ~> FacturationForOther",
				"source(output(",
				"          Commande as string,",
				"          {Référence Offre BA} as string,",
				"          {Qté Cdée} as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> ArticulationSap",
				"source(output(",
				"          DateOffre as string,",
				"          {Date Prev Cde} as string,",
				"          {Code projet} as string,",
				"          Projet as string,",
				"          Type as string,",
				"          {CP projet} as string,",
				"          {Ville projet} as string,",
				"          NbLogement as string,",
				"          {Référence} as string,",
				"          Marque as string,",
				"          Famille as string,",
				"          Produit as string,",
				"          {Quantité} as string,",
				"          {Prix de base} as string,",
				"          {Prix DO} as string,",
				"          {Prix pro} as string,",
				"          {Prix total} as string,",
				"          {Numéro interne 1} as string,",
				"          Client as string,",
				"          {Ville client} as string,",
				"          {Type financement} as string,",
				"          {Numéro interne 2} as string,",
				"          {Négoce} as string,",
				"          {Ville négoce} as string,",
				"          {Statut offre} as string,",
				"          Responsable as string,",
				"          Groupe as string,",
				"          Offre as string,",
				"          {Date de maj statut} as string,",
				"          {Numéro avant vente} as string,",
				"          {Créateur offre} as string,",
				"          {Commentaire interne} as string,",
				"          {Offre dérogée} as string,",
				"          {Contrat cadre} as string,",
				"          {Offre nationale} as string,",
				"          {Année Tarif} as string,",
				"          PotentielP1N as string,",
				"          PotentielP2N as string,",
				"          PotentielP3N as string,",
				"          PotentielP4N as string,",
				"          PotentielP5N as string,",
				"          PotentielP6N as string,",
				"          {DateFinValidité} as string,",
				"          CODE_CMI as string,",
				"          NOM_CMI as string,",
				"          CodeATC as string,",
				"          DEEE as string,",
				"          OffreSupprimee as string,",
				"          {Date de création} as string,",
				"          NomSignataire1 as string,",
				"          NomSignataire2 as string,",
				"          DateSignataire1 as string,",
				"          DateSignataire2 as string,",
				"          {DateDérogation} as string,",
				"          Canal as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> stgOffre",
				"source(output(",
				"          Article as string,",
				"          Distributeur as string,",
				"          prix_unitaire as string,",
				"          {Durée_période} as string,",
				"          {Période} as string,",
				"          {Mois début} as string,",
				"          {Mois fin} as string,",
				"          mois1 as string,",
				"          annee1 as string,",
				"          mois2 as string,",
				"          annee2 as string,",
				"          dd as string,",
				"          month as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> PrixPeriode",
				"source(output(",
				"          yearmonth as string,",
				"          year as string,",
				"          month as string,",
				"          qte_ecoulement as string,",
				"          ca_ecoulement as string,",
				"          POSSAMidString as string,",
				"          HubSAPid as string,",
				"          reference as string,",
				"          distributeur as string,",
				"          agence_code as string,",
				"          marque as string,",
				"          {Code postal} as string,",
				"          marque_name as string,",
				"          toreplicate as string,",
				"          dd as string,",
				"          indexcols2 as string,",
				"          qte_ecc as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> ecoulmnt",
				"FacturationForOther filter({Canal distribution} != \"42\") ~> filter1",
				"filter1, ArticulationSap join({Document de vente} == Commande,",
				"     joinType:'inner',",
				"     broadcast: 'auto')~> join1",
				"join1, select1 join({Référence Offre BA} == Offre,",
				"     joinType:'inner',",
				"     broadcast: 'auto')~> join2",
				"derivedColumn5 filter({Canal distribution}==\"43\") ~> Canal43",
				"PrixPeriode derive({Période} = iif(length({Période})>1,{Période},\"0\"+{Période})) ~> derivedColumn1",
				"derivedColumn1 select(mapColumn(",
				"          Article,",
				"          Distributeur,",
				"          {Période},",
				"          annee2,",
				"          month",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> columnChoicePrix",
				"derivedColumn2, columnChoicePrix join(replace(lower(tempDist), \" \", \"\") == replace(lower(Distributeur), \" \", \"\")",
				"     && toInteger(year) == toInteger(annee2)",
				"     && toInteger({Mois calendrier}) == toInteger(month)",
				"     && coalesce(toString(toInteger(replace(reference, \" \", \"\"))),replace(reference, \" \", \"\")) == coalesce(toString(toInteger(replace(Article, \" \", \"\"))),replace(Article, \" \", \"\")),",
				"     joinType:'left',",
				"     broadcast: 'auto')~> join3",
				"select3 derive(toroll = mapLoop(abs(toInteger( {Qté facturée})), #index),",
				"          tempDist = iif(lower(WholeSalerID)=='ancs - accueil négoce chauffage sanitaire','partedis',\r",
				"  iif(instr(lower(WholeSalerID), 'trva - tereva' )>0, 'tereva', \r",
				"   iif(instr(lower(WholeSalerID), 'dsc')>0, 'dsc', \r",
				"    iif(instr(lower(WholeSalerID), 'vf' )>0, 'vf_confort', \r",
				"     iif(instr(lower(WholeSalerID), 'sonac' )>0, 'sonac',\r",
				"lower(WholeSalerID))))))) ~> derivedColumn2",
				"join3 derive({Période} = coalesce( {Période}, \"00\" )) ~> derivedColumn3",
				"derivedColumn3 foldDown(unroll(toroll, toroll),",
				"     mapColumn(",
				"          {Org commerciale} = { Org commerciale},",
				"          {Canal distribution},",
				"          {Secteur d'activité},",
				"          {Document de vente},",
				"          Poste,",
				"          {Jour calendaire},",
				"          {Agence commerciale corrigé},",
				"          {ATC Corrigé},",
				"          {Donneur d'ordre},",
				"          {Recept de march},",
				"          {Destinataire facture},",
				"          {Type doc vente},",
				"          {Type de poste},",
				"          Livraison,",
				"          {Type de livraison},",
				"          {Type poste Livraison},",
				"          Facture,",
				"          {Type de facture},",
				"          {Type poste Facture},",
				"          {Mois calendrier},",
				"          {Année civile},",
				"          {Motif commande},",
				"          {Qté cdée} = select3@{Qté cdée},",
				"          {CA cdé},",
				"          {Qté livrée},",
				"          {CA livré},",
				"          {Qté facturée},",
				"          {CA facturé},",
				"          {Cout standard cdé},",
				"          {Cout fabrication},",
				"          {Cout standard livré},",
				"          {Cout standard facturé},",
				"          date_id,",
				"          year,",
				"          yearmonth,",
				"          qt_cd_e,",
				"          ca_cd_,",
				"          qt_livr_e,",
				"          qt_factur_e,",
				"          ca_factur_,",
				"          year_month,",
				"          reference,",
				"          WholeSalerID,",
				"          WholeSalerHubID,",
				"          HubName,",
				"          POSSAMidString,",
				"          toreplicate,",
				"          toroll,",
				"          {Période},",
				"          Offre",
				"     ),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> torolltoList",
				"torolltoList derive(ref2 = coalesce(toString(toInteger(replace(reference, \" \", \"\"))),replace(reference, \" \", \"\"))) ~> derivedColumn4",
				"derivedColumn4 window(over(year,",
				"          {Période},",
				"          HubSAPid = POSSAMidString,",
				"          ref2),",
				"     asc(yearmonth, true),",
				"     asc(POSSAMidString, true),",
				"     asc(reference, true),",
				"     indexcols2 = rowNumber()) ~> createIndexPartedis",
				"createIndexPartedis derive(indexcols2 = year+\"-\"+{Période}+\"-\"+POSSAMidString+\"-\"+coalesce(toString(toInteger(replace(reference, \" \", \"\"))),replace(reference, \" \", \"\"))+\"-\"+toString(indexcols2),",
				"          {Qté facturée} = iif(toDouble({Qté facturée})<=0, -1, 1)) ~> derivedColumn5",
				"stgOffre select(mapColumn(",
				"          Offre,",
				"          {Numéro interne 2}",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select1",
				"ecoulmnt select(mapColumn(",
				"          yearmonth,",
				"          year,",
				"          month,",
				"          qte_ecoulement,",
				"          ca_ecoulement,",
				"          POSSAMidString,",
				"          HubSAPid,",
				"          reference,",
				"          distributeur,",
				"          agence_code,",
				"          marque,",
				"          {Code postal},",
				"          marque_name,",
				"          toreplicate,",
				"          dd,",
				"          indexcols2,",
				"          qte_ecc",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> endEcoulement",
				"join2 select(mapColumn(",
				"          { Org commerciale},",
				"          {Canal distribution},",
				"          {Secteur d'activité},",
				"          {Document de vente},",
				"          Poste,",
				"          {Jour calendaire},",
				"          {1ereDateLivrDdee},",
				"          {Agence commerciale corrigé},",
				"          {ATC Corrigé},",
				"          {Donneur d'ordre},",
				"          {Recept de march},",
				"          {Destinataire facture},",
				"          {Type doc vente},",
				"          {Type de poste},",
				"          Livraison,",
				"          {Type de livraison},",
				"          {Type poste Livraison},",
				"          Facture,",
				"          {Type de facture},",
				"          {Type poste Facture},",
				"          {Mois calendrier},",
				"          {Année civile},",
				"          {Motif commande},",
				"          {Qté cdée} = FacturationForOther@{Qté cdée},",
				"          {CA cdé},",
				"          {Qté livrée},",
				"          {CA livré},",
				"          {Qté facturée},",
				"          {CA facturé},",
				"          {Cout standard cdé},",
				"          {Cout fabrication},",
				"          {Cout standard livré},",
				"          {Cout standard facturé},",
				"          date_id,",
				"          year,",
				"          yearmonth,",
				"          qt_cd_e,",
				"          ca_cd_,",
				"          qt_livr_e,",
				"          ca_livr_,",
				"          qt_factur_e,",
				"          ca_factur_,",
				"          year_month,",
				"          reference,",
				"          WholeSalerID,",
				"          WholeSalerHubID,",
				"          HubName,",
				"          HubSAPid,",
				"          toreplicate,",
				"          Commande,",
				"          {Référence Offre BA},",
				"          {Qté Cdée} = ArticulationSap@{Qté Cdée},",
				"          Offre,",
				"          POSSAMidString = {Numéro interne 2}",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: false) ~> select3",
				"Canal43, endEcoulement join(derivedColumn5@indexcols2 == endEcoulement@indexcols2,",
				"     joinType:'inner',",
				"     broadcast: 'auto')~> join4",
				"derivedColumn5 filter({Canal distribution}==\"51\" || {Canal distribution}==\"45\") ~> filter2",
				"filter2, endEcoulement join(derivedColumn5@indexcols2 == endEcoulement@indexcols2,",
				"     joinType:'inner',",
				"     broadcast: 'auto')~> join5",
				"derivedColumn3, endEcoulement join(select3@POSSAMidString == endEcoulement@POSSAMidString,",
				"     joinType:'inner',",
				"     broadcast: 'auto')~> join6",
				"derivedColumn5 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          {yearmonth;reference;Code client;qte_ecoulement} as string",
				"     ),",
				"     partitionFileNames:['TestAvantJoinVentederogé.csv'],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     partitionBy('hash', 1)) ~> sink1"
			]
		}
	}
}