{
	"name": "UNIFORMISATION_OFFRE",
	"properties": {
		"folder": {
			"name": "REFERENTIEL"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ALL_OFFRE_DIFFUS",
						"type": "DatasetReference"
					},
					"name": "offreDiffusInput"
				},
				{
					"dataset": {
						"referenceName": "ALL_OFFRE_CHANTIER",
						"type": "DatasetReference"
					},
					"name": "offreChantierInput"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "Stg_offre_diffus",
						"type": "DatasetReference"
					},
					"name": "stagingDiffus"
				},
				{
					"dataset": {
						"referenceName": "Stg_offre_chantier",
						"type": "DatasetReference"
					},
					"name": "stagingChantier"
				},
				{
					"dataset": {
						"referenceName": "stg_offre",
						"type": "DatasetReference"
					},
					"name": "sink1"
				}
			],
			"transformations": [
				{
					"name": "canalDiffus"
				},
				{
					"name": "columnsChoiceDiffus"
				},
				{
					"name": "typeCast",
					"description": "Autogenerated by data preview actions"
				},
				{
					"name": "canalChantier"
				},
				{
					"name": "columnsChoiceChantier"
				},
				{
					"name": "typeCastChantier"
				},
				{
					"name": "DerivedColumn1"
				},
				{
					"name": "cleanProduit"
				},
				{
					"name": "Filter1"
				},
				{
					"name": "Filter2"
				},
				{
					"name": "Filter3"
				},
				{
					"name": "DerivedColumn3"
				},
				{
					"name": "endChantier"
				},
				{
					"name": "endDiffus"
				},
				{
					"name": "Union1"
				},
				{
					"name": "Select2"
				},
				{
					"name": "Select3"
				}
			],
			"script": "source(output(\n\t\t{DateDébutValidité} as string,\n\t\t{Date Prev Cde} as string,\n\t\t{Code projet} as string,\n\t\tProjet as string,\n\t\tType as string,\n\t\t{CP projet} as string,\n\t\t{Ville projet} as string,\n\t\tNbLogement as string,\n\t\t{Référence} as string,\n\t\tMarque as string,\n\t\tFamille as string,\n\t\tProduit as string,\n\t\t{Quantité} as string,\n\t\t{Prix de base} as string,\n\t\t{Prix DO} as string,\n\t\t{Prix pro} as string,\n\t\t{Prix total} as string,\n\t\t{Numéro interne 1} as string,\n\t\tClient as string,\n\t\t{Ville client} as string,\n\t\t{Type financement} as string,\n\t\t{Numéro interne 2} as string,\n\t\t{Négoce} as string,\n\t\t{Ville négoce} as string,\n\t\t{Statut offre} as string,\n\t\tResponsable as string,\n\t\tGroupe as string,\n\t\tOffre as string,\n\t\t{Date de maj statut} as string,\n\t\t{Numéro avant vente} as string,\n\t\t{Créateur offre} as string,\n\t\t{Commentaire interne} as string,\n\t\t{Offre dérogée} as string,\n\t\t{Contrat cadre} as string,\n\t\t{Offre nationale} as string,\n\t\t{Année Tarif} as string,\n\t\tPotentielP1N as string,\n\t\tPotentielP2N as string,\n\t\tPotentielP3N as string,\n\t\tPotentielP4N as string,\n\t\tPotentielP5N as string,\n\t\tPotentielP6N as string,\n\t\t{DateFinValidité} as string,\n\t\tCODE_CMI as string,\n\t\tNOM_CMI as string,\n\t\tCodeATC as string,\n\t\tDEEE as string,\n\t\tOffreSupprimee as string,\n\t\t{Date de création} as string,\n\t\tNomSignataire1 as string,\n\t\tNomSignataire2 as string,\n\t\tDateSignataire1 as string,\n\t\tDateSignataire2 as string,\n\t\t{DateDérogation} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> offreDiffusInput\nsource(output(\n\t\t{DateDébutValidité} as string,\n\t\t{Date Prev Cde} as string,\n\t\t{Code projet} as string,\n\t\tProjet as string,\n\t\tType as string,\n\t\t{CP projet} as string,\n\t\t{Ville projet} as string,\n\t\tNbLogement as string,\n\t\t{Référence} as string,\n\t\tMarque as string,\n\t\tFamille as string,\n\t\tProduit as string,\n\t\t{Quantité} as string,\n\t\t{Prix de base} as string,\n\t\t{Prix DO} as string,\n\t\t{Prix pro} as string,\n\t\t{Prix total} as string,\n\t\t{Numéro interne 1} as string,\n\t\tClient as string,\n\t\t{Ville client} as string,\n\t\t{Type financement} as string,\n\t\t{Numéro interne 2} as string,\n\t\t{Négoce} as string,\n\t\t{Ville négoce} as string,\n\t\t{Statut offre} as string,\n\t\tResponsable as string,\n\t\tGroupe as string,\n\t\tOffre as string,\n\t\t{Date de maj statut} as string,\n\t\t{Numéro avant vente} as string,\n\t\t{Créateur offre} as string,\n\t\t{Commentaire interne} as string,\n\t\t{Offre dérogée} as string,\n\t\t{Contrat cadre} as string,\n\t\t{Offre nationale} as string,\n\t\t{Année Tarif} as string,\n\t\tPotentielP1N as string,\n\t\tPotentielP2N as string,\n\t\tPotentielP3N as string,\n\t\tPotentielP4N as string,\n\t\tPotentielP5N as string,\n\t\tPotentielP6N as string,\n\t\t{DateFinValidité} as string,\n\t\tCODE_CMI as string,\n\t\tNOM_CMI as string,\n\t\tCodeATC as string,\n\t\tDEEE as string,\n\t\tOffreSupprimee as string,\n\t\t{Date de création} as string,\n\t\tNomSignataire1 as string,\n\t\tNomSignataire2 as string,\n\t\tDateSignataire1 as string,\n\t\tDateSignataire2 as string,\n\t\t{DateDérogation} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> offreChantierInput\nFilter1 derive(Canal = \"Diffus\",\n\t\told_ref = {Référence},\n\t\t{Référence} = iif(substring({Référence},1,2) == \"00\", substring({Référence},3,length({Référence})-2), {Référence})) ~> canalDiffus\ncanalDiffus select(mapColumn(\n\t\tDateOffre = {DateDébutValidité},\n\t\t{Date Prev Cde},\n\t\t{Code projet},\n\t\tProjet,\n\t\tType,\n\t\t{CP projet},\n\t\t{Ville projet},\n\t\tNbLogement,\n\t\t{Référence},\n\t\tMarque,\n\t\tFamille,\n\t\tProduit,\n\t\t{Quantité},\n\t\t{Prix de base},\n\t\t{Prix DO},\n\t\t{Prix pro},\n\t\t{Prix total},\n\t\t{Numéro interne 1},\n\t\tClient,\n\t\t{Ville client},\n\t\t{Type financement},\n\t\t{Numéro interne 2},\n\t\t{Négoce},\n\t\t{Ville négoce},\n\t\t{Statut offre},\n\t\tResponsable,\n\t\tGroupe,\n\t\tOffre,\n\t\t{Date de maj statut},\n\t\t{Numéro avant vente},\n\t\t{Créateur offre},\n\t\t{Commentaire interne},\n\t\t{Offre dérogée},\n\t\t{Contrat cadre},\n\t\t{Offre nationale},\n\t\t{Année Tarif},\n\t\tPotentielP1N,\n\t\tPotentielP2N,\n\t\tPotentielP3N,\n\t\tPotentielP4N,\n\t\tPotentielP5N,\n\t\tPotentielP6N,\n\t\t{DateFinValidité},\n\t\tCODE_CMI,\n\t\tNOM_CMI,\n\t\tCodeATC,\n\t\tDEEE,\n\t\tOffreSupprimee,\n\t\t{Date de création},\n\t\tNomSignataire1,\n\t\tNomSignataire2,\n\t\tDateSignataire1,\n\t\tDateSignataire2,\n\t\t{DateDérogation},\n\t\tCanal\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> columnsChoiceDiffus\ncolumnsChoiceDiffus derive({Quantité} = toDouble({Quantité}),\n\t\tDateOffre = toDate(split( split(DateOffre, \" \")[1] , '/')[1] +\"/\"+ iif(length(split( split(DateOffre, \" \")[1] , '/')[2])==2, split( split(DateOffre, \" \")[1] , '/')[2], \"0\"+split( split(DateOffre, \" \")[1] , '/')[2])+\"/\"+split( split(DateOffre, \" \")[1] , '/')[3], \"dd/mm/yyyy\")) ~> typeCast\nFilter2 derive(Canal = \"Chantier\",\n\t\t{Référence} = iif(substring({Référence},1,2) == \"00\", substring({Référence},3,length({Référence})-2), {Référence})) ~> canalChantier\ncanalChantier select(mapColumn(\n\t\tDateOffre = {DateDébutValidité},\n\t\t{Date Prev Cde},\n\t\t{Code projet},\n\t\tProjet,\n\t\tType,\n\t\t{CP projet},\n\t\t{Ville projet},\n\t\tNbLogement,\n\t\t{Référence},\n\t\tMarque,\n\t\tFamille,\n\t\tProduit,\n\t\t{Quantité},\n\t\t{Prix de base},\n\t\t{Prix DO},\n\t\t{Prix pro},\n\t\t{Prix total},\n\t\t{Numéro interne 1},\n\t\tClient,\n\t\t{Ville client},\n\t\t{Type financement},\n\t\t{Numéro interne 2},\n\t\t{Négoce},\n\t\t{Ville négoce},\n\t\t{Statut offre},\n\t\tResponsable,\n\t\tGroupe,\n\t\tOffre,\n\t\t{Date de maj statut},\n\t\t{Numéro avant vente},\n\t\t{Créateur offre},\n\t\t{Commentaire interne},\n\t\t{Offre dérogée},\n\t\t{Contrat cadre},\n\t\t{Offre nationale},\n\t\t{Année Tarif},\n\t\tPotentielP1N,\n\t\tPotentielP2N,\n\t\tPotentielP3N,\n\t\tPotentielP4N,\n\t\tPotentielP5N,\n\t\tPotentielP6N,\n\t\t{DateFinValidité},\n\t\tCODE_CMI,\n\t\tNOM_CMI,\n\t\tCodeATC,\n\t\tDEEE,\n\t\tOffreSupprimee,\n\t\t{Date de création},\n\t\tNomSignataire1,\n\t\tNomSignataire2,\n\t\tDateSignataire1,\n\t\tDateSignataire2,\n\t\t{DateDérogation},\n\t\tCanal\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> columnsChoiceChantier\ncolumnsChoiceChantier derive(DateOffre = toDate(split(DateOffre, \" \")[1],\"dd/mm/yyyy\"),\n\t\t{Quantité} = toDouble({Quantité})) ~> typeCastChantier\ntypeCastChantier derive(Produit = replace(Produit, '\"', \"\")) ~> DerivedColumn1\nDerivedColumn1 derive(Produit = replace(Produit, \"'\", \" \")) ~> cleanProduit\noffreDiffusInput filter(!isNull(Offre)) ~> Filter1\noffreChantierInput filter(!isNull(Offre)) ~> Filter2\noffreChantierInput filter(Offre==\"ZADX6708\") ~> Filter3\nFilter3 derive({Référence} = iif(substring({Référence},1,2) == \"00\", substring({Référence},3,length({Référence})-2), {Référence})) ~> DerivedColumn3\ncleanProduit select(mapColumn(\n\t\tDateOffre,\n\t\t{Date Prev Cde},\n\t\t{Code projet},\n\t\tProjet,\n\t\tType,\n\t\t{CP projet},\n\t\t{Ville projet},\n\t\tNbLogement,\n\t\t{Référence},\n\t\tMarque,\n\t\tFamille,\n\t\tProduit,\n\t\t{Quantité},\n\t\t{Prix de base},\n\t\t{Prix DO},\n\t\t{Prix pro},\n\t\t{Prix total},\n\t\t{Numéro interne 1},\n\t\tClient,\n\t\t{Ville client},\n\t\t{Type financement},\n\t\t{Numéro interne 2},\n\t\t{Négoce},\n\t\t{Ville négoce},\n\t\t{Statut offre},\n\t\tResponsable,\n\t\tGroupe,\n\t\tOffre,\n\t\t{Date de maj statut},\n\t\t{Numéro avant vente},\n\t\t{Créateur offre},\n\t\t{Commentaire interne},\n\t\t{Offre dérogée},\n\t\t{Contrat cadre},\n\t\t{Offre nationale},\n\t\t{Année Tarif},\n\t\tPotentielP1N,\n\t\tPotentielP2N,\n\t\tPotentielP3N,\n\t\tPotentielP4N,\n\t\tPotentielP5N,\n\t\tPotentielP6N,\n\t\t{DateFinValidité},\n\t\tCODE_CMI,\n\t\tNOM_CMI,\n\t\tCodeATC,\n\t\tDEEE,\n\t\tOffreSupprimee,\n\t\t{Date de création},\n\t\tNomSignataire1,\n\t\tNomSignataire2,\n\t\tDateSignataire1,\n\t\tDateSignataire2,\n\t\t{DateDérogation},\n\t\tCanal\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> endChantier\ntypeCast select(mapColumn(\n\t\tDateOffre,\n\t\t{Date Prev Cde},\n\t\t{Code projet},\n\t\tProjet,\n\t\tType,\n\t\t{CP projet},\n\t\t{Ville projet},\n\t\tNbLogement,\n\t\t{Référence},\n\t\tMarque,\n\t\tFamille,\n\t\tProduit,\n\t\t{Quantité},\n\t\t{Prix de base},\n\t\t{Prix DO},\n\t\t{Prix pro},\n\t\t{Prix total},\n\t\t{Numéro interne 1},\n\t\tClient,\n\t\t{Ville client},\n\t\t{Type financement},\n\t\t{Numéro interne 2},\n\t\t{Négoce},\n\t\t{Ville négoce},\n\t\t{Statut offre},\n\t\tResponsable,\n\t\tGroupe,\n\t\tOffre,\n\t\t{Date de maj statut},\n\t\t{Numéro avant vente},\n\t\t{Créateur offre},\n\t\t{Commentaire interne},\n\t\t{Offre dérogée},\n\t\t{Contrat cadre},\n\t\t{Offre nationale},\n\t\t{Année Tarif},\n\t\tPotentielP1N,\n\t\tPotentielP2N,\n\t\tPotentielP3N,\n\t\tPotentielP4N,\n\t\tPotentielP5N,\n\t\tPotentielP6N,\n\t\t{DateFinValidité},\n\t\tCODE_CMI,\n\t\tNOM_CMI,\n\t\tCodeATC,\n\t\tDEEE,\n\t\tOffreSupprimee,\n\t\t{Date de création},\n\t\tNomSignataire1,\n\t\tNomSignataire2,\n\t\tDateSignataire1,\n\t\tDateSignataire2,\n\t\t{DateDérogation},\n\t\tCanal\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> endDiffus\nendDiffus, endChantier union(byName: true)~> Union1\ncanalChantier select(mapColumn(\n\t\t{DateDébutValidité},\n\t\t{Date Prev Cde},\n\t\t{Code projet},\n\t\tProjet,\n\t\tType,\n\t\t{CP projet},\n\t\t{Ville projet},\n\t\tNbLogement,\n\t\t{Référence},\n\t\tMarque,\n\t\tFamille,\n\t\tProduit,\n\t\t{Quantité},\n\t\t{Prix de base},\n\t\t{Prix DO},\n\t\t{Prix pro},\n\t\t{Prix total},\n\t\t{Numéro interne 1},\n\t\tClient,\n\t\t{Ville client},\n\t\t{Type financement},\n\t\t{Numéro interne 2},\n\t\t{Négoce},\n\t\t{Ville négoce},\n\t\t{Statut offre},\n\t\tResponsable,\n\t\tGroupe,\n\t\tOffre,\n\t\t{Date de maj statut},\n\t\t{Numéro avant vente},\n\t\t{Créateur offre},\n\t\t{Commentaire interne},\n\t\t{Offre dérogée},\n\t\t{Contrat cadre},\n\t\t{Offre nationale},\n\t\t{Année Tarif},\n\t\tPotentielP1N,\n\t\tPotentielP2N,\n\t\tPotentielP3N,\n\t\tPotentielP4N,\n\t\tPotentielP5N,\n\t\tPotentielP6N,\n\t\t{DateFinValidité},\n\t\tCODE_CMI,\n\t\tNOM_CMI,\n\t\tCodeATC,\n\t\tDEEE,\n\t\tOffreSupprimee,\n\t\t{Date de création},\n\t\tNomSignataire1,\n\t\tNomSignataire2,\n\t\tDateSignataire1,\n\t\tDateSignataire2,\n\t\t{DateDérogation},\n\t\tCanal\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select2\ncanalDiffus select(mapColumn(\n\t\t{DateDébutValidité},\n\t\t{Date Prev Cde},\n\t\t{Code projet},\n\t\tProjet,\n\t\tType,\n\t\t{CP projet},\n\t\t{Ville projet},\n\t\tNbLogement,\n\t\tMarque,\n\t\tFamille,\n\t\tProduit,\n\t\t{Quantité},\n\t\t{Prix de base},\n\t\t{Prix DO},\n\t\t{Prix pro},\n\t\t{Prix total},\n\t\t{Numéro interne 1},\n\t\tClient,\n\t\t{Ville client},\n\t\t{Type financement},\n\t\t{Numéro interne 2},\n\t\t{Négoce},\n\t\t{Ville négoce},\n\t\t{Statut offre},\n\t\tResponsable,\n\t\tGroupe,\n\t\tOffre,\n\t\t{Date de maj statut},\n\t\t{Numéro avant vente},\n\t\t{Créateur offre},\n\t\t{Commentaire interne},\n\t\t{Offre dérogée},\n\t\t{Contrat cadre},\n\t\t{Offre nationale},\n\t\t{Année Tarif},\n\t\tPotentielP1N,\n\t\tPotentielP2N,\n\t\tPotentielP3N,\n\t\tPotentielP4N,\n\t\tPotentielP5N,\n\t\tPotentielP6N,\n\t\t{DateFinValidité},\n\t\tCODE_CMI,\n\t\tNOM_CMI,\n\t\tCodeATC,\n\t\tDEEE,\n\t\tOffreSupprimee,\n\t\t{Date de création},\n\t\tNomSignataire1,\n\t\tNomSignataire2,\n\t\tDateSignataire1,\n\t\tDateSignataire2,\n\t\t{DateDérogation},\n\t\tCanal,\n\t\t{Référence} = old_ref\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select3\nSelect3 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tpartitionFileNames:['STG_OFFRE_DIFFUS.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> stagingDiffus\nSelect2 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tpartitionFileNames:['STG_OFFRE_CHANTIER.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> stagingChantier\nUnion1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tDateOffre as string,\n\t\t{Date Prev Cde} as string,\n\t\t{Code projet} as string,\n\t\tProjet as string,\n\t\tType as string,\n\t\t{CP projet} as string,\n\t\t{Ville projet} as string,\n\t\tNbLogement as string,\n\t\t{Référence} as string,\n\t\tMarque as string,\n\t\tFamille as string,\n\t\tProduit as string,\n\t\t{Quantité} as string,\n\t\t{Prix de base} as string,\n\t\t{Prix client} as string,\n\t\t{Prix négoce} as string,\n\t\t{Prix total} as string,\n\t\tClient as string,\n\t\t{Type financement} as string,\n\t\t{Ville client} as string,\n\t\t{Numéro interne 1} as string,\n\t\t{Négoce} as string,\n\t\t{Ville négoce} as string,\n\t\t{Numéro interne 2} as string,\n\t\t{Statut offre} as string,\n\t\tResponsable as string,\n\t\tGroupe as string,\n\t\tOffre as string,\n\t\t{Date de maj statut} as string,\n\t\t{Numéro avant vente} as string,\n\t\t{Créateur offre} as string,\n\t\t{Commentaire interne} as string,\n\t\t{Offre dérogée} as string,\n\t\t{Contrat cadre} as string,\n\t\t{Typologie projet} as string,\n\t\tDateValidite as string,\n\t\tDEEE as string,\n\t\tOffreSupprimee as string,\n\t\tCanal as string\n\t),\n\tpartitionFileNames:['stg_offre.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> sink1"
		}
	}
}