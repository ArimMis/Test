{
	"name": "VF_CONFORT_PREPARATION",
	"properties": {
		"folder": {
			"name": "PREPARATION ECOULEMENT"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "VFINPUT",
						"type": "DatasetReference"
					},
					"name": "ecoulement"
				},
				{
					"dataset": {
						"referenceName": "CONFORT_ORGANISATION",
						"type": "DatasetReference"
					},
					"name": "organisation"
				},
				{
					"dataset": {
						"referenceName": "VENTES_DIRECTES_PREPARED",
						"type": "DatasetReference"
					},
					"name": "ventesDirectes"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "CONFORT_QTE_NULL",
						"type": "DatasetReference"
					},
					"name": "outputQuantityNull"
				},
				{
					"dataset": {
						"referenceName": "VFCONFORT_ECOULEMENT_PREPARED",
						"type": "DatasetReference"
					},
					"name": "VFCONFORTECOULPREPARED"
				},
				{
					"dataset": {
						"referenceName": "VFCONFORT_ORGANISATION_NOTFOUND",
						"type": "DatasetReference"
					},
					"name": "VFCONFORTORGANISATIONNOTFOUND"
				}
			],
			"transformations": [
				{
					"name": "fdecrementation",
					"flowlet": {
						"referenceName": "decrementationVenteDirecte",
						"type": "DataFlowReference"
					}
				},
				{
					"name": "yearmonth"
				},
				{
					"name": "yearAndMonth"
				},
				{
					"name": "quantityNull"
				},
				{
					"name": "quantityNotNull"
				},
				{
					"name": "rename"
				},
				{
					"name": "codePointVenteNotNull"
				},
				{
					"name": "cleansing"
				},
				{
					"name": "posidNotNull"
				},
				{
					"name": "uniqueOrganisation"
				},
				{
					"name": "innerOrganisation"
				},
				{
					"name": "RenameVentesDirectes"
				},
				{
					"name": "innerVentesDirectes"
				},
				{
					"name": "leftVentesDirectes"
				},
				{
					"name": "outerleftVentesDirectes"
				},
				{
					"name": "uniformisation"
				},
				{
					"name": "fullLeftUnion"
				},
				{
					"name": "Addcolumn"
				},
				{
					"name": "leftOrganisation"
				},
				{
					"name": "posidNULL"
				},
				{
					"name": "select1"
				},
				{
					"name": "select2"
				},
				{
					"name": "select3"
				},
				{
					"name": "aggregate1"
				},
				{
					"name": "idDecrementation"
				},
				{
					"name": "select4"
				},
				{
					"name": "derivedColumn2"
				},
				{
					"name": "select5"
				},
				{
					"name": "endDecrementation"
				},
				{
					"name": "join1"
				},
				{
					"name": "derivedColumn3"
				}
			],
			"script": "source(output(\n\t\t{représentant} as string,\n\t\t{n° département} as string,\n\t\t{département} as string,\n\t\t{code point de vente} as string,\n\t\t{libellé point de vente} as string,\n\t\t{code depot source} as string,\n\t\t{code client} as string,\n\t\tclient as string,\n\t\t{n° siret} as string,\n\t\t{code postal} as string,\n\t\tville as string,\n\t\t{année livraison} as string,\n\t\t{mois livraison} as string,\n\t\t{code fournisseur} as string,\n\t\t{fournisseur principal} as string,\n\t\t{code produit} as string,\n\t\tproduit as string,\n\t\t{réference} as string,\n\t\t{qte en unité de vente} as string,\n\t\t{montant prv net} as string,\n\t\tpath as string,\n\t\t{numéro fournisseur} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> ecoulement\nsource(output(\n\t\tWholeSalerID as string,\n\t\tWholeSalerShortName as string,\n\t\tUnitID as string,\n\t\tPOSid as string,\n\t\tPOSdescription as string,\n\t\tCounty as string,\n\t\tPOSSAMid as string,\n\t\tPOSSAMidString as string,\n\t\tSupplierID as string,\n\t\tBrandID as string,\n\t\tWholeSalerHubID as string,\n\t\tHubName as string,\n\t\tHubSAPid as string,\n\t\tSectorID as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> organisation\nsource(output(\n\t\tyear as string,\n\t\treference as string,\n\t\t{Code client} as string,\n\t\tqte_ecoulement as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> ventesDirectes\nselect5 compose(mapColumn(\n\t\tid = idDecrementation,\n\t\tPossAMid = POSSAMidString,\n\t\treference = {Réference},\n\t\tyear,\n\t\tmonth,\n\t\tqte_ecoulement,\n\t\tqte_venteDirecte = {Qté ventes directes}\n\t),\n\tcomposition: 'decrementationVenteDirecte') ~> fdecrementation@(output1)\nrename derive(yearmonth = regexExtract(fileName , '(\\\\d+)'),\n\t\tqte_ecoulement = toDouble(qte_ecoulement)) ~> yearmonth\nyearmonth derive(year = substring(yearmonth, 1, 4),\n\t\tmonth = substring(yearmonth, 5 ,2)) ~> yearAndMonth\nyearAndMonth filter(isNull(qte_ecoulement)) ~> quantityNull\naggregate1 filter(!isNull(qte_ecoulement)) ~> quantityNotNull\necoulement select(mapColumn(\n\t\t{Code point de vente} = {code point de vente},\n\t\t{Code Depot source} = {code depot source},\n\t\t{Code client} = {code client},\n\t\tClient = client,\n\t\t{Code postal} = {code postal},\n\t\tVille = ville,\n\t\t{Mois livraison} = {mois livraison},\n\t\t{code fournisseur},\n\t\t{fournisseur principal},\n\t\t{Code produit} = {code produit},\n\t\tproduit,\n\t\t{Montant prv net} = {montant prv net},\n\t\t{Représentant} = {représentant},\n\t\t{N° Département} = {n° département},\n\t\t{Département} = {département},\n\t\t{Libellé point de vente} = {libellé point de vente},\n\t\t{N° Siret} = {n° siret},\n\t\t{Année livraison} = {année livraison},\n\t\t{Réference} = {réference},\n\t\tqte_ecoulement = {qte en unité de vente},\n\t\tfileName = path\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> rename\nquantityNotNull filter(!isNull({Code point de vente})) ~> codePointVenteNotNull\norganisation derive(POSid = trim(POSid, \" \"),\n\t\tHubSAPid = trim(HubSAPid, \" \")) ~> cleansing\ncleansing filter(!isNull(POSid)) ~> posidNotNull\nposidNotNull aggregate(groupBy(POSid,\n\t\tHubSAPid),\n\tWholeSalerID = max(WholeSalerID),\n\t\tWholeSalerShortName = max(WholeSalerShortName),\n\t\tUnitID = max(UnitID),\n\t\tPOSdescription = max(POSdescription),\n\t\tCounty = max(County),\n\t\tPOSSAMid = max(POSSAMid),\n\t\tPOSSAMidString = max(POSSAMidString),\n\t\tSupplierID = max(SupplierID),\n\t\tBrandID = max(BrandID),\n\t\tWholeSalerHubID = max(WholeSalerHubID),\n\t\tHubName = max(HubName),\n\t\tSectorID = max(SectorID)) ~> uniqueOrganisation\ncodePointVenteNotNull, uniqueOrganisation join({Code point de vente} == POSid,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> innerOrganisation\nventesDirectes select(mapColumn(\n\t\tyear,\n\t\tArticle = reference,\n\t\t{Code client_right} = {Code client},\n\t\t{Qté ventes directes} = qte_ecoulement\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> RenameVentesDirectes\ninnerOrganisation, RenameVentesDirectes join(aggregate1@year == RenameVentesDirectes@year\n\t&& coalesce(toString(toInteger(replace({Réference}, \" \", \"\"))),replace({Réference}, \" \", \"\")) == coalesce(toString(toInteger(replace(Article, \" \", \"\"))),replace(Article, \" \", \"\"))\n\t&& POSSAMid == {Code client_right},\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> innerVentesDirectes\ninnerOrganisation, RenameVentesDirectes join(aggregate1@year == RenameVentesDirectes@year\n\t&& coalesce(toString(toInteger(replace({Réference}, \" \", \"\"))),replace({Réference}, \" \", \"\")) == coalesce(toString(toInteger(replace(Article, \" \", \"\"))),replace(Article, \" \", \"\"))\n\t&& POSSAMid == {Code client_right},\n\tjoinType:'left',\n\tbroadcast: 'auto')~> leftVentesDirectes\nselect2 filter(isNull(yearmonth) || isNull(Article) || isNull({Code client_right})) ~> outerleftVentesDirectes\nAddcolumn select(mapColumn(\n\t\t{Code postal},\n\t\tmarque_file = {fournisseur principal},\n\t\tarticle = produit,\n\t\tca_ecoulement = {Montant prv net},\n\t\treference = {Réference},\n\t\tqte_ecoulement,\n\t\tyearmonth,\n\t\tyear,\n\t\tmonth,\n\t\tUnitID,\n\t\tCounty,\n\t\tPOSSAMidString,\n\t\tmarque_id = BrandID,\n\t\tHubSAPid,\n\t\tdistributeur\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> uniformisation\nderivedColumn3, outerleftVentesDirectes union(byName: true)~> fullLeftUnion\nfullLeftUnion derive(canal = '',\n\t\tdistributeur = \"vf_confort\") ~> Addcolumn\ncodePointVenteNotNull, uniqueOrganisation join({Code point de vente} == POSid,\n\tjoinType:'left',\n\tbroadcast: 'auto')~> leftOrganisation\nleftOrganisation filter(isNull(POSid)) ~> posidNULL\ninnerVentesDirectes select(mapColumn(\n\t\t{Code point de vente},\n\t\t{Code Depot source},\n\t\t{Code postal},\n\t\t{Montant prv net},\n\t\t{Mois livraison},\n\t\t{code fournisseur},\n\t\t{fournisseur principal},\n\t\t{Code produit},\n\t\tproduit,\n\t\t{Libellé point de vente},\n\t\t{Année livraison},\n\t\t{Réference},\n\t\tqte_ecoulement,\n\t\tfileName,\n\t\tyearmonth,\n\t\tyear = aggregate1@year,\n\t\tmonth,\n\t\tPOSid,\n\t\tHubSAPid,\n\t\tWholeSalerID,\n\t\tWholeSalerShortName,\n\t\tUnitID,\n\t\tPOSdescription,\n\t\tCounty,\n\t\tPOSSAMid,\n\t\tPOSSAMidString,\n\t\tSupplierID,\n\t\tBrandID,\n\t\tWholeSalerHubID,\n\t\tHubName,\n\t\tSectorID,\n\t\tArticle,\n\t\t{Code client_right},\n\t\t{Qté ventes directes}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select1\nleftVentesDirectes select(mapColumn(\n\t\t{Code point de vente},\n\t\t{Code Depot source},\n\t\t{Code postal},\n\t\t{Mois livraison},\n\t\t{Montant prv net},\n\t\t{code fournisseur},\n\t\t{fournisseur principal},\n\t\t{Code produit},\n\t\tproduit,\n\t\t{Libellé point de vente},\n\t\t{Année livraison},\n\t\t{Réference},\n\t\tqte_ecoulement,\n\t\tfileName,\n\t\tyearmonth,\n\t\tyear = aggregate1@year,\n\t\tmonth,\n\t\tPOSid,\n\t\tHubSAPid,\n\t\tWholeSalerID,\n\t\tWholeSalerShortName,\n\t\tUnitID,\n\t\tPOSdescription,\n\t\tCounty,\n\t\tPOSSAMid,\n\t\tPOSSAMidString,\n\t\tSupplierID,\n\t\tBrandID,\n\t\tWholeSalerHubID,\n\t\tHubName,\n\t\tSectorID,\n\t\tArticle,\n\t\t{Code client_right},\n\t\t{Qté ventes directes}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select2\nidDecrementation select(mapColumn(\n\t\t{Code point de vente},\n\t\t{Code Depot source},\n\t\t{Code postal},\n\t\t{Montant prv net},\n\t\t{Mois livraison},\n\t\t{code fournisseur},\n\t\t{fournisseur principal},\n\t\t{Code produit},\n\t\tproduit,\n\t\t{Libellé point de vente},\n\t\t{Année livraison},\n\t\t{Réference},\n\t\tqte_ecoulement,\n\t\tfileName,\n\t\tyearmonth,\n\t\tyear,\n\t\tmonth,\n\t\tPOSid,\n\t\tHubSAPid,\n\t\tWholeSalerID,\n\t\tWholeSalerShortName,\n\t\tUnitID,\n\t\tPOSdescription,\n\t\tCounty,\n\t\tPOSSAMid,\n\t\tPOSSAMidString,\n\t\tSupplierID,\n\t\tBrandID,\n\t\tWholeSalerHubID,\n\t\tHubName,\n\t\tSectorID,\n\t\tArticle,\n\t\t{Code client_right},\n\t\t{Qté ventes directes},\n\t\tidDecrementation\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select3\nyearAndMonth aggregate(groupBy({Code point de vente},\n\t\t{Code Depot source},\n\t\t{Code postal},\n\t\t{Mois livraison},\n\t\t{code fournisseur},\n\t\t{fournisseur principal},\n\t\t{Code produit},\n\t\tproduit,\n\t\t{Libellé point de vente},\n\t\t{Année livraison},\n\t\t{Réference},\n\t\tfileName,\n\t\tyearmonth,\n\t\tyear,\n\t\tmonth),\n\tqte_ecoulement = sum(qte_ecoulement),\n\t\t{Montant prv net} = sum(toDouble({Montant prv net}))) ~> aggregate1\nselect1 keyGenerate(output(idDecrementation as long),\n\tstartAt: 1L,\n\tstepValue: 1L) ~> idDecrementation\nidDecrementation select(mapColumn(\n\t\tidDecrementation,\n\t\tPOSSAMidString,\n\t\t{Réference},\n\t\tyear,\n\t\tmonth,\n\t\tqte_ecoulement,\n\t\t{Qté ventes directes}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select4\nselect4 derive(month = toInteger(month),\n\t\tqte_ecoulement = toFloat(qte_ecoulement),\n\t\t{Qté ventes directes} = toFloat({Qté ventes directes})) ~> derivedColumn2\nderivedColumn2 select(mapColumn(\n\t\tidDecrementation,\n\t\tPOSSAMidString,\n\t\t{Réference},\n\t\tyear,\n\t\tmonth,\n\t\tqte_ecoulement,\n\t\t{Qté ventes directes}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select5\nfdecrementation@output1 select(mapColumn(\n\t\tid,\n\t\tqt_final\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> endDecrementation\nselect3, endDecrementation join(idDecrementation == id,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> join1\njoin1 derive(qte_ecoulement = qt_final) ~> derivedColumn3\nquantityNull sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tpartitionFileNames:['VFCONFORT_QTE_NULL.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> outputQuantityNull\nuniformisation sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\t{Région Statistique} as string,\n\t\tEnseigne as string,\n\t\t{Marque DESC} as string,\n\t\t{Marque Code} as string,\n\t\t{Sous Famille} as string,\n\t\t{Référence Article Fournisseur} as string,\n\t\t{Article National DESC} as string,\n\t\t{Article National Code} as string,\n\t\t{Agence Code} as string,\n\t\t{Agence DESC} as string,\n\t\t{Département DESC} as string,\n\t\t{Département ID} as string,\n\t\tSecteur as string,\n\t\t{Quantité en UV BL} as string,\n\t\t{Année Précédente (Quantité en UV BL)} as string,\n\t\t{Cumul Exercice (Quantité en UV BL)} as string,\n\t\t{Cumul Exercice A-1 (Quantité en UV BL)} as string,\n\t\t{MOIS CA PRR N} as string,\n\t\t{MOIS CA PRR N-1} as string,\n\t\t{CA PRR au cumul} as string,\n\t\t{CA PRR au cumul N-1} as string,\n\t\tfileName as string\n\t),\n\tpartitionFileNames:['VFCONFORT_ECOUL_PREPARED.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> VFCONFORTECOULPREPARED\nposidNULL sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\t{Marque DESC} as string,\n\t\t{Marque Code} as string,\n\t\t{Sous Famille} as string,\n\t\t{Référence Article Fournisseur} as string,\n\t\t{Agence Code} as string,\n\t\t{Département ID} as string,\n\t\t{Quantité en UV BL} as string,\n\t\tyearmonth as string,\n\t\tyear as string,\n\t\tmonth as string,\n\t\tPOSid as string,\n\t\tWholeSalerID as string,\n\t\tPOSSAMidString as string,\n\t\tHubSAPid as string,\n\t\tBrandID as string\n\t),\n\tpartitionFileNames:['VFCONFORT_ORGANISATION_NOTFOUND.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> VFCONFORTORGANISATIONNOTFOUND"
		}
	}
}