{
	"name": "SUIVIE_OFFRE_DIFFUS",
	"properties": {
		"folder": {
			"name": "SUIVI OFFRE"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "STG_OFFRE_DIFFUS_INPUT",
						"type": "DatasetReference"
					},
					"name": "stgOffre"
				},
				{
					"dataset": {
						"referenceName": "InputBaseCommercialMarketing",
						"type": "DatasetReference"
					},
					"name": "baseCommerciale"
				},
				{
					"dataset": {
						"referenceName": "article_hierarchi",
						"type": "DatasetReference"
					},
					"name": "articleHierarchi"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "OFFRE_SANS_MATCHING_DIFFUS",
						"type": "DatasetReference"
					},
					"name": "offreSansMatching"
				},
				{
					"dataset": {
						"referenceName": "SUIVI_OFFRE_DIFFUS",
						"type": "DatasetReference"
					},
					"name": "OUTputffreDiffus"
				}
			],
			"transformations": [
				{
					"name": "aggregationOffre"
				},
				{
					"name": "offreNotNULL"
				},
				{
					"name": "offreNotNullBase"
				},
				{
					"name": "aggregationBaseold"
				},
				{
					"name": "leftOffreBase"
				},
				{
					"name": "yearmonth"
				},
				{
					"name": "dropColumnsInCommonLeft"
				},
				{
					"name": "fullRightOffrebase"
				},
				{
					"name": "right"
				},
				{
					"name": "dropColumnsInCommonRight"
				},
				{
					"name": "DerivedColumn1"
				},
				{
					"name": "Join1"
				},
				{
					"name": "endArticle"
				},
				{
					"name": "Select1"
				},
				{
					"name": "Aggregate1"
				},
				{
					"name": "DerivedColumn2"
				},
				{
					"name": "Join2"
				},
				{
					"name": "DerivedColumn3"
				},
				{
					"name": "DerivedColumn4"
				},
				{
					"name": "Aggregate2"
				}
			],
			"script": "source(output(\n\t\t{DateDébutValidité} as string,\n\t\t{Date Prev Cde} as string,\n\t\t{Code projet} as string,\n\t\tProjet as string,\n\t\tType as string,\n\t\t{CP projet} as string,\n\t\t{Ville projet} as string,\n\t\tNbLogement as string,\n\t\t{Référence} as string,\n\t\tMarque as string,\n\t\tFamille as string,\n\t\tProduit as string,\n\t\t{Quantité} as string,\n\t\t{Prix de base} as string,\n\t\t{Prix DO} as string,\n\t\t{Prix pro} as string,\n\t\t{Prix total} as string,\n\t\t{Numéro interne 1} as string,\n\t\tClient as string,\n\t\t{Ville client} as string,\n\t\t{Type financement} as string,\n\t\t{Numéro interne 2} as string,\n\t\t{Négoce} as string,\n\t\t{Ville négoce} as string,\n\t\t{Statut offre} as string,\n\t\tResponsable as string,\n\t\tGroupe as string,\n\t\tOffre as string,\n\t\t{Date de maj statut} as string,\n\t\t{Numéro avant vente} as string,\n\t\t{Créateur offre} as string,\n\t\t{Commentaire interne} as string,\n\t\t{Offre dérogée} as string,\n\t\t{Contrat cadre} as string,\n\t\t{Offre nationale} as string,\n\t\t{Année Tarif} as string,\n\t\tPotentielP1N as string,\n\t\tPotentielP2N as string,\n\t\tPotentielP3N as string,\n\t\tPotentielP4N as string,\n\t\tPotentielP5N as string,\n\t\tPotentielP6N as string,\n\t\t{DateFinValidité} as string,\n\t\tCODE_CMI as string,\n\t\tNOM_CMI as string,\n\t\tCodeATC as string,\n\t\tDEEE as string,\n\t\tOffreSupprimee as string,\n\t\t{Date de création} as string,\n\t\tNomSignataire1 as string,\n\t\tNomSignataire2 as string,\n\t\tDateSignataire1 as string,\n\t\tDateSignataire2 as string,\n\t\t{DateDérogation} as string,\n\t\tCanal as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> stgOffre\nsource(output(\n\t\t{affecte/non_affecte} as string,\n\t\t{plateforme/vente directe} as string,\n\t\t{origine de la ligne} as string,\n\t\tyear as string,\n\t\tmonth as string,\n\t\t{Code client livré} as string,\n\t\t{code client plateforme livree} as string,\n\t\t{code produit} as string,\n\t\tquantite as string,\n\t\tca as string,\n\t\t{Code postal} as string,\n\t\tmarque as string,\n\t\tmarque_code as string,\n\t\tcanal_distribution_final as string,\n\t\t{nom du canal} as string,\n\t\tcanal_final as string,\n\t\tdocument_vente as string,\n\t\t{Agence commerciale corrigé (vente directe)} as string,\n\t\t{Donneur d'ordre (vente directe)} as string,\n\t\t{Facture (vente directe)} as string,\n\t\t{Type poste Facture (vente directe)} as string,\n\t\tno_offre as string,\n\t\t{ATC Corrigé} as string,\n\t\t{ATC offre} as string,\n\t\t{ATC livré} as string,\n\t\t{ATC Performance} as string,\n\t\tNomATC as string,\n\t\tMatricule as string,\n\t\t{Motif commande} as string,\n\t\t{Type de facture} as string,\n\t\tN1groupe as string,\n\t\tN2groupe as string,\n\t\tN3groupe as string,\n\t\tN4groupe as string,\n\t\tN5groupe as string,\n\t\tN6groupe as string,\n\t\tN7groupe as string,\n\t\tN1groupedesignation as string,\n\t\tN2groupedesignation as string,\n\t\tN3groupedesignation as string,\n\t\tN4groupedesignation as string,\n\t\tN5groupedesignation as string,\n\t\tN6groupedesignation as string,\n\t\tN7groupedesignation as string,\n\t\tN1localedesignation as string,\n\t\tN2localedesignation as string,\n\t\tN3localedesignation as string,\n\t\tN4localedesignation as string,\n\t\tN5localedesignation as string,\n\t\tN6localedesignation as string,\n\t\tN7localedesignation as string,\n\t\tN1locale as string,\n\t\tN2locale as string,\n\t\tN3locale as string,\n\t\tN4locale as string,\n\t\tN5locale as string,\n\t\tN6locale as string,\n\t\tN7locale as string,\n\t\t{Hiérarchgroupe} as string,\n\t\t{Hiérarchlocale} as string,\n\t\t{Numéro du compte} as string,\n\t\t{EPS_Nom du compte} as string,\n\t\t{EPS_Groupe cible/Typologie générale} as string,\n\t\t{EPS_Sous groupe cible/Typologie détaillée} as string,\n\t\t{EPS_Compte principal: Numéro du compte} as string,\n\t\t{EPS_Compte principal: Nom du compte} as string,\n\t\tClient as string,\n\t\t{Numéro client indirect} as string,\n\t\tCODE_CMI as string,\n\t\tNOM_CMI as string,\n\t\t{Nom du compte} as string,\n\t\t{Client Indirect_ Groupe cible/Typologie générale} as string,\n\t\t{Client Indirect_ Sous groupe cible/Typologie détaillée} as string,\n\t\t{Client Indirect_  Compte principal: Numéro du compte} as string,\n\t\t{Client Indirect_  Compte principal: Nom du compte} as string,\n\t\t{Client Direct - Hiérarchie N1 SAP } as string,\n\t\t{Client Direct - Hiérarchie N2 SAP } as string,\n\t\t{Client Indirect - Hiérarchie N1 SAP} as string,\n\t\t{Client Indirect - Hiérarchie N2 SAP} as string,\n\t\tyearmonth as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> baseCommerciale\nsource(output(\n\t\tOrgCm as string,\n\t\tCDis as string,\n\t\tArticle as string,\n\t\tDescription as string,\n\t\t{Hiérarch.groupe} as string,\n\t\t{Hiérarch.locale} as string,\n\t\tPredecessor as string,\n\t\tSuccessor as string,\n\t\tSt as string,\n\t\t{Désignation Statut} as string,\n\t\t{Déb. val.} as string,\n\t\t{N1.groupe} as string,\n\t\t{N2.groupe} as string,\n\t\t{N3.groupe} as string,\n\t\t{N4.groupe} as string,\n\t\t{N5.groupe} as string,\n\t\t{N6.groupe} as string,\n\t\t{N7.groupe} as string,\n\t\t{N1.locale} as string,\n\t\t{N2.locale} as string,\n\t\t{N3.locale} as string,\n\t\t{N4.locale} as string,\n\t\t{N5.locale} as string,\n\t\t{N6.locale} as string,\n\t\t{N7.locale} as string,\n\t\t{N1.groupe.designation} as string,\n\t\t{N2.groupe.designation} as string,\n\t\t{N3.groupe.designation} as string,\n\t\t{N4.groupe.designation} as string,\n\t\t{N5.groupe.designation} as string,\n\t\t{N6.groupe.designation} as string,\n\t\t{N7.groupe.designation} as string,\n\t\t{N1.locale.designation} as string,\n\t\t{N2.locale.designation} as string,\n\t\t{N3.locale.designation} as string,\n\t\t{N4.locale.designation} as string,\n\t\t{N5.locale.designation} as string,\n\t\t{N6.locale.designation} as string,\n\t\t{N7.locale.designation} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> articleHierarchi\noffreNotNULL aggregate(groupBy(Offre,\n\t\t{Référence},\n\t\tCanal),\n\t{Statut offre} = last({Statut offre}),\n\t\t{Numéro interne 1} = first({Numéro interne 1}),\n\t\tResponsable = last(Responsable),\n\t\t{Négoce} = first({Négoce}),\n\t\t{Numéro interne 2} = first({Numéro interne 2}),\n\t\tCODE_CMI = first(CODE_CMI),\n\t\tNOM_CMI = first(NOM_CMI),\n\t\t{Date fin de validité} = max({DateFinValidité}),\n\t\t{Quantité de l'offre} = sum(toInteger({Quantité})),\n\t\tQuantite_P1N = first(PotentielP1N),\n\t\tQuantite_P2N = first(PotentielP2N),\n\t\tQuantite_P3N = first(PotentielP3N),\n\t\tQuantite_P4N = first(PotentielP4N),\n\t\tQuantite_P5N = first(PotentielP5N),\n\t\tQuantite_P6N = first(PotentielP6N)) ~> aggregationOffre\nDerivedColumn1 filter(!isNull(Offre)) ~> offreNotNULL\nbaseCommerciale filter(!isNull(no_offre) && canal_final==\"Diffus\") ~> offreNotNullBase\noffreNotNullBase aggregate(groupBy({plateforme/vente directe},\n\t\tno_offre,\n\t\t{code produit}),\n\t{Quantité consommée} = sum(toInteger(quantite)),\n\t\t{dernière facturation année} = max(toInteger(year)),\n\t\t{dernière facturation mois} = max(toInteger(month))) ~> aggregationBaseold\naggregationOffre, aggregationBaseold join(Offre == no_offre\n\t&& {Référence} == {code produit},\n\tjoinType:'left',\n\tbroadcast: 'auto')~> leftOffreBase\nleftOffreBase derive({Date de dernière facturation de l'offre} = toString({dernière facturation année})+\"-\"+toString({dernière facturation mois}),\n\t\tCanal = \"Diffus\") ~> yearmonth\nyearmonth select(mapColumn(\n\t\tOffre,\n\t\t{Référence},\n\t\tCanal,\n\t\t{Date fin de validité},\n\t\t{Quantité de l'offre},\n\t\tQuantite_P1N,\n\t\tQuantite_P2N,\n\t\tQuantite_P3N,\n\t\tQuantite_P4N,\n\t\tQuantite_P5N,\n\t\tQuantite_P6N,\n\t\t{Quantité consommée},\n\t\t{Date de dernière facturation de l'offre},\n\t\t{Statut offre},\n\t\tResponsable,\n\t\t{Numéro interne 1},\n\t\t{Négoce},\n\t\t{Numéro interne 2},\n\t\tCODE_CMI,\n\t\tNOM_CMI\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> dropColumnsInCommonLeft\naggregationOffre, aggregationBaseold join(Offre == no_offre\n\t&& {Référence} == {code produit},\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> fullRightOffrebase\nfullRightOffrebase filter(isNull(Offre) || isNull({Référence})) ~> right\nright select(mapColumn(\n\t\tOffre,\n\t\t{Référence},\n\t\tCanal,\n\t\t{Statut offre},\n\t\tResponsable,\n\t\t{Numéro interne 1},\n\t\t{Négoce},\n\t\t{Numéro interne 2},\n\t\tCODE_CMI,\n\t\tNOM_CMI,\n\t\t{Date fin de validité},\n\t\t{Quantité de l'offre},\n\t\tQuantite_P1N,\n\t\tQuantite_P2N,\n\t\tQuantite_P3N,\n\t\tQuantite_P4N,\n\t\tQuantite_P5N,\n\t\tQuantite_P6N,\n\t\t{plateforme/vente directe},\n\t\t{Quantité consommée},\n\t\t{dernière facturation année},\n\t\t{dernière facturation mois}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> dropColumnsInCommonRight\nstgOffre derive({DateFinValidité} = split({DateFinValidité}, \" \")[1]) ~> DerivedColumn1\noffreNotNULL, endArticle join(iif(isInteger({Référence}), toString(toInteger({Référence})), {Référence}) == iif(isInteger(Article), toString(toInteger(Article)), Article),\n\tjoinType:'left',\n\tbroadcast: 'auto')~> Join1\narticleHierarchi select(mapColumn(\n\t\tOrgCm,\n\t\tCDis,\n\t\tArticle,\n\t\tDescription,\n\t\t{Hiérarch.groupe},\n\t\t{Hiérarch.locale},\n\t\tPredecessor,\n\t\tSuccessor,\n\t\tSt,\n\t\t{Désignation Statut},\n\t\t{Déb. val.},\n\t\t{N1.locale},\n\t\t{N2.locale},\n\t\t{N3.locale},\n\t\t{N4.locale},\n\t\t{N5.locale},\n\t\t{N6.locale},\n\t\t{N7.locale}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> endArticle\nJoin1 select(mapColumn(\n\t\teach(match(true()))\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nDerivedColumn2 aggregate(groupBy(Offre),\n\tPotentielP1N = sum(toInteger(PotentielP1N)),\n\t\tPotentielP2N = sum(toInteger(PotentielP2N)),\n\t\tPotentielP3N = sum(toInteger(PotentielP3N)),\n\t\tPotentielP4N = sum(toInteger(PotentielP4N)),\n\t\tPotentielP5N = sum(toInteger(PotentielP5N)),\n\t\tPotentielP6N = sum(toInteger(PotentielP6N)),\n\t\t{DateFinValidité} = max({DateFinValidité}),\n\t\tCODE_CMI = first(CODE_CMI),\n\t\tNOM_CMI = first(NOM_CMI),\n\t\tResponsable = last(Responsable),\n\t\t{Numéro interne 1} = last({Numéro interne 1}),\n\t\t{Numéro interne 2} = last({Numéro interne 2}),\n\t\t{Négoce} = last({Négoce}),\n\t\t{Statut offre} = last({Statut offre})) ~> Aggregate1\nSelect1 derive(PotentielP1N = iif( {N1.locale}==\"FB\", coalesce(PotentielP1N , {Quantité}), \"\" ),\n\t\tPotentielP2N = iif( {N1.locale}==\"FA\", coalesce(PotentielP2N , {Quantité}), \"\" ),\n\t\tPotentielP3N = iif( {N2.locale}==\"FP1\", coalesce(PotentielP3N , {Quantité}), \"\" ),\n\t\tPotentielP4N = iif( {N2.locale}==\"FR1\", coalesce(PotentielP4N , {Quantité}), \"\" ),\n\t\tPotentielP5N = iif( {N3.locale}==\"FP41\", coalesce(PotentielP5N , {Quantité}), \"\" ),\n\t\tPotentielP6N = iif( {N3.locale}==\"FC21\", coalesce(PotentielP6N , {Quantité}), \"\" )) ~> DerivedColumn2\nAggregate1, Aggregate2 join(Offre == no_offre,\n\tjoinType:'left',\n\tbroadcast: 'auto')~> Join2\nJoin2 derive(Canal = \"Diffus\") ~> DerivedColumn3\noffreNotNullBase derive(Realise_PotentielP1N = iif( N1locale==\"FB\",  quantite, \"\" ),\n\t\tRealise_PotentielP2N = iif( N1locale==\"FA\", quantite, \"\" ),\n\t\tRealise_PotentielP3N = iif( N2locale==\"FP1\", quantite, \"\" ),\n\t\tRealise_PotentielP4N = iif( N2locale==\"FR1\", quantite  , \"\" ),\n\t\tRealise_PotentielP5N = iif( N3locale==\"FP41\", quantite, \"\" ),\n\t\tRealise_PotentielP6N = iif( N3locale==\"FC21\", quantite, \"\" )) ~> DerivedColumn4\nDerivedColumn4 aggregate(groupBy(no_offre),\n\tRealise_PotentielP1N = sum(toInteger(Realise_PotentielP1N)),\n\t\tRealise_PotentielP2N = sum(toInteger(Realise_PotentielP2N)),\n\t\tRealise_PotentielP3N = sum(toInteger(Realise_PotentielP3N)),\n\t\tRealise_PotentielP4N = sum(toInteger(Realise_PotentielP4N)),\n\t\tRealise_PotentielP5N = sum(toInteger(Realise_PotentielP5N)),\n\t\tRealise_PotentielP6N = sum(toInteger(Realise_PotentielP6N))) ~> Aggregate2\ndropColumnsInCommonRight sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tColumn_1 as string,\n\t\tColumn_2 as string,\n\t\tColumn_3 as string,\n\t\tColumn_4 as string,\n\t\tColumn_5 as string,\n\t\tColumn_6 as string,\n\t\tColumn_7 as string,\n\t\tColumn_8 as string,\n\t\tColumn_9 as string,\n\t\tColumn_10 as string\n\t),\n\tpartitionFileNames:['offre_et_baseCom_sans_matching_diffus.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> offreSansMatching\nDerivedColumn3 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tpartitionFileNames:['SUIVI_OFFRE_DIFFUS.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> OUTputffreDiffus"
		}
	}
}