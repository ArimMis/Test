{
	"name": "TEREVA_PREPARATION",
	"properties": {
		"folder": {
			"name": "PREPARATION ECOULEMENT"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "TEREVA_ECOULEMENT_INPUT",
						"type": "DatasetReference"
					},
					"name": "ECOULEMENT"
				},
				{
					"dataset": {
						"referenceName": "TEREVA_ORGANISATION",
						"type": "DatasetReference"
					},
					"name": "organisation"
				},
				{
					"dataset": {
						"referenceName": "VENTES_DIRECTES_PREPARED",
						"type": "DatasetReference"
					},
					"name": "ventesDirectes"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "TEREVA_EC_PREPARED",
						"type": "DatasetReference"
					},
					"name": "TEREVAECOULPREPARED"
				},
				{
					"dataset": {
						"referenceName": "TerevaOrgaNotFound",
						"type": "DatasetReference"
					},
					"name": "TEREVAORGANISATIONNOTFOUND"
				},
				{
					"dataset": {
						"referenceName": "terevaQteNull",
						"type": "DatasetReference"
					},
					"name": "terevaQteNull"
				}
			],
			"transformations": [
				{
					"name": "yearmonthANDcanal"
				},
				{
					"name": "yearANDmonth"
				},
				{
					"name": "agenceCodeNotNull"
				},
				{
					"name": "posIDNotNull"
				},
				{
					"name": "innerOrganisation"
				},
				{
					"name": "uniqueOrganisation"
				},
				{
					"name": "innerVentesDirectes"
				},
				{
					"name": "deleteVentesDirectes"
				},
				{
					"name": "rename"
				},
				{
					"name": "leftVentesDirectes"
				},
				{
					"name": "outerLeftVentesDirectes"
				},
				{
					"name": "dropColumnsInCommon1"
				},
				{
					"name": "dropColumnsInCommon"
				},
				{
					"name": "fullLeftUnion"
				},
				{
					"name": "uniformisation"
				},
				{
					"name": "marquename"
				},
				{
					"name": "fullLeftOrganisation"
				},
				{
					"name": "leftOnly"
				},
				{
					"name": "ConditionalSplit1"
				},
				{
					"name": "EndVentesDirectes"
				},
				{
					"name": "window1"
				},
				{
					"name": "window2"
				},
				{
					"name": "select1"
				},
				{
					"name": "derivedColumn1"
				}
			],
			"script": "source(output(\n\t\tProp_0 as string,\n\t\tsociete as string,\n\t\tregion_lib as string,\n\t\tsgeo as string,\n\t\tsgeo_lib as string,\n\t\tagence as string,\n\t\tagence_lib as string,\n\t\tdep_ag as string,\n\t\tfrs as string,\n\t\tarticle as string,\n\t\tarticle_lib as string,\n\t\tdm as string,\n\t\tref_frs as string,\n\t\t{vva (m) n} as string,\n\t\t{vva (m) n-1} as string,\n\t\t{qte (m) n} as string,\n\t\t{qte (m) n-1} as string,\n\t\t{vva (c) n} as string,\n\t\t{vva (c) n-1} as string,\n\t\t{qte (c) n} as string,\n\t\t{qte (c) n-1} as string,\n\t\t{var. vva (m)} as string,\n\t\t{var. qte (m)} as string,\n\t\t{var. vva (c)} as string,\n\t\t{var. qte (c)} as string,\n\t\tpath as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> ECOULEMENT\nsource(output(\n\t\tWholeSalerID as string,\n\t\tWholeSalerShortName as string,\n\t\tUnitID as string,\n\t\tPOSid as string,\n\t\tPOSdescription as string,\n\t\tCounty as string,\n\t\tPOSSAMid as string,\n\t\tPOSSAMidString as string,\n\t\tSupplierID as string,\n\t\tBrandID as string,\n\t\tWholeSalerHubID as string,\n\t\tHubName as string,\n\t\tHubSAPid as string,\n\t\tSectorID as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> organisation\nsource(output(\n\t\tyear as string,\n\t\treference as string,\n\t\t{Code client} as string,\n\t\tqte_ecoulement as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> ventesDirectes\nrename derive(yearmonth = replace(split(split(path, \"/\")[3], \"_\")[1], \"-\", \"\"),\n\t\tcanal = split(split(path, \"/\")[3], \"_\")[2],\n\t\tqte_ecoulement = toDouble(qte_ecoulement)) ~> yearmonthANDcanal\nConditionalSplit1@qteNotNul derive(year = substring(yearmonth, 1, 4),\n\t\tmonth = substring(yearmonth, 5, 2)) ~> yearANDmonth\nyearANDmonth filter(!isNull(agence_code)) ~> agenceCodeNotNull\norganisation filter(!isNull(POSid)) ~> posIDNotNull\nagenceCodeNotNull, uniqueOrganisation join(agence_code == POSid,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> innerOrganisation\nposIDNotNull aggregate(groupBy(POSid,\n\t\tHubSAPid),\n\tWholeSalerID = max(WholeSalerID),\n\t\tWholeSalerShortName = max(WholeSalerShortName),\n\t\tUnitID = max(UnitID),\n\t\tPOSdescription = max(POSdescription),\n\t\tCounty = max(County),\n\t\tPOSSAMid = max(POSSAMid),\n\t\tSupplierID = max(SupplierID),\n\t\tBrandID = max(BrandID),\n\t\tWholeSalerHubID = max(WholeSalerHubID),\n\t\tHubName = max(HubName),\n\t\tSectorID = max(SectorID)) ~> uniqueOrganisation\nwindow1, EndVentesDirectes join(yearANDmonth@year == EndVentesDirectes@year\n\t&& ConditionalSplit1@qteNotNul@reference == EndVentesDirectes@reference\n\t&& POSSAMid == {Code client},\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> innerVentesDirectes\nselect1 derive(ecart = toDouble(qte_cumul)-toDouble({Qté vente direct}),\n\t\tsigne = iif(toDouble(qte_cumul)-toDouble({Qté vente direct}) <=0 , 0, 1)) ~> deleteVentesDirectes\nECOULEMENT select(mapColumn(\n\t\tsociete,\n\t\tregion_lib,\n\t\tsgeo,\n\t\tsgeo_lib,\n\t\tagence_code = agence,\n\t\tagence_lib,\n\t\tdep_ag,\n\t\tmarque_file = frs,\n\t\tarticle_lib,\n\t\tdm,\n\t\treference = ref_frs,\n\t\tqte_ecoulement = {qte (m) n},\n\t\tpath\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> rename\ninnerOrganisation, EndVentesDirectes join(yearANDmonth@year == EndVentesDirectes@year\n\t&& coalesce(toString(toInteger(replace(ConditionalSplit1@qteNotNul@reference, \" \", \"\"))),replace(ConditionalSplit1@qteNotNul@reference, \" \", \"\")) == coalesce(toString(toInteger(replace(EndVentesDirectes@reference, \" \", \"\"))),replace(EndVentesDirectes@reference, \" \", \"\"))\n\t&& POSSAMid == {Code client},\n\tjoinType:'left',\n\tbroadcast: 'auto')~> leftVentesDirectes\nleftVentesDirectes filter(isNull(EndVentesDirectes@reference) || isNull(EndVentesDirectes@year) || isNull({Code client})) ~> outerLeftVentesDirectes\nderivedColumn1 select(mapColumn(\n\t\tsociete,\n\t\tregion_lib,\n\t\tsgeo,\n\t\tsgeo_lib,\n\t\tagence_code,\n\t\tagence_lib,\n\t\tdep_ag,\n\t\tmarque_file,\n\t\tarticle_lib,\n\t\tdm,\n\t\treference = ConditionalSplit1@qteNotNul@reference,\n\t\tqte_ecoulement = ecart,\n\t\tpath,\n\t\tyearmonth,\n\t\tcanal,\n\t\tyear = yearANDmonth@year,\n\t\tmonth,\n\t\tPOSid,\n\t\tHubSAPid,\n\t\tWholeSalerID,\n\t\tWholeSalerShortName,\n\t\tUnitID,\n\t\tPOSdescription,\n\t\tCounty,\n\t\tPOSSAMid,\n\t\tSupplierID,\n\t\tBrandID,\n\t\tWholeSalerHubID,\n\t\tHubName,\n\t\tSectorID\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> dropColumnsInCommon1\nouterLeftVentesDirectes select(mapColumn(\n\t\tsociete,\n\t\tregion_lib,\n\t\tsgeo,\n\t\tsgeo_lib,\n\t\tagence_code,\n\t\tagence_lib,\n\t\tdep_ag,\n\t\tmarque_file,\n\t\tarticle_lib,\n\t\tdm,\n\t\treference = ConditionalSplit1@qteNotNul@reference,\n\t\tqte_ecoulement,\n\t\tpath,\n\t\tyearmonth,\n\t\tcanal,\n\t\tyear = yearANDmonth@year,\n\t\tmonth,\n\t\tPOSid,\n\t\tHubSAPid,\n\t\tWholeSalerID,\n\t\tWholeSalerShortName,\n\t\tUnitID,\n\t\tPOSdescription,\n\t\tCounty,\n\t\tPOSSAMid,\n\t\tSupplierID,\n\t\tBrandID,\n\t\tWholeSalerHubID,\n\t\tHubName,\n\t\tSectorID\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> dropColumnsInCommon\ndropColumnsInCommon1, dropColumnsInCommon union(byName: true)~> fullLeftUnion\nmarquename select(mapColumn(\n\t\tdistributeur = societe,\n\t\tagence_code,\n\t\tmarque_file,\n\t\treference,\n\t\tqte_ecoulement,\n\t\tyearmonth,\n\t\tcanal,\n\t\tyear,\n\t\tmonth,\n\t\tHubSAPid,\n\t\tCounty,\n\t\tPOSSAMid,\n\t\tmarque_id = BrandID\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> uniformisation\nfullLeftUnion derive(marque_name = \"SaunierDuval\",\n\t\tmarque = \"1604\",\n\t\tmarque_num = \"1604\") ~> marquename\nagenceCodeNotNull, uniqueOrganisation join(agence_code == POSid,\n\tjoinType:'left',\n\tbroadcast: 'auto')~> fullLeftOrganisation\nfullLeftOrganisation filter(isNull(POSid)) ~> leftOnly\nyearmonthANDcanal split(qte_ecoulement!=0,\n\tdisjoint: false) ~> ConditionalSplit1@(qteNotNul, qteNull)\nventesDirectes select(mapColumn(\n\t\tyear,\n\t\treference,\n\t\t{Code client},\n\t\t{Qté vente direct} = qte_ecoulement\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> EndVentesDirectes\ninnerOrganisation window(over(year,\n\t\tPOSSAMid,\n\t\treference),\n\tasc(month, true),\n\tqte_cumul = sum(qte_ecoulement)) ~> window1\ndeleteVentesDirectes window(over(year,\n\t\treference,\n\t\tPOSSAMid),\n\tasc(month, true),\n\tsigne_cumul = sum(signe)) ~> window2\ninnerVentesDirectes select(mapColumn(\n\t\tsociete,\n\t\tregion_lib,\n\t\tsgeo,\n\t\tsgeo_lib,\n\t\tagence_code,\n\t\tagence_lib,\n\t\tdep_ag,\n\t\tmarque_file,\n\t\tarticle_lib,\n\t\tdm,\n\t\treference = ConditionalSplit1@qteNotNul@reference,\n\t\tqte_ecoulement,\n\t\tpath,\n\t\tyearmonth,\n\t\tcanal,\n\t\tyear = yearANDmonth@year,\n\t\tmonth,\n\t\tPOSid,\n\t\tHubSAPid,\n\t\tWholeSalerID,\n\t\tWholeSalerShortName,\n\t\tUnitID,\n\t\tPOSdescription,\n\t\tCounty,\n\t\tPOSSAMid,\n\t\tSupplierID,\n\t\tBrandID,\n\t\tWholeSalerHubID,\n\t\tHubName,\n\t\tSectorID,\n\t\tqte_cumul,\n\t\treference = EndVentesDirectes@reference,\n\t\t{Code client},\n\t\t{Qté vente direct}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select1\nwindow2 derive(qte_ecoulement = iif( signe_cumul <1,0, iif (signe_cumul ==1 , toInteger(ecart), toInteger( qte_ecoulement)   ) )) ~> derivedColumn1\nuniformisation sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tyearmonth as string,\n\t\tqte_ecoulement as string,\n\t\tca_ecoulement as string,\n\t\tPOSSAMidString as string,\n\t\tHubSAPid as string,\n\t\treference as string,\n\t\tdistributeur as string,\n\t\t{Code postal} as string,\n\t\tmarque_name as string,\n\t\tis_prix_dsc as string,\n\t\tqte_ecc as string,\n\t\t{Canal distribution} as string,\n\t\t{Secteur d'activit�} as string,\n\t\tdocument_vente as string,\n\t\t{Jour calendaire} as string,\n\t\t{Agence commerciale corrig�} as string,\n\t\t{Donneur d'ordre} as string,\n\t\t{R�cept. de march.} as string,\n\t\tRight_reference as string,\n\t\tFacture as string,\n\t\t{Type poste Facture} as string,\n\t\t{Qt� factur�e} as string,\n\t\t{CA factur�} as string,\n\t\tRight_HubSAPid as string,\n\t\t{Type_Facturation�} as string,\n\t\tqt_fact as string,\n\t\tca_final as string,\n\t\tqt_final as string,\n\t\tdata_origin as string,\n\t\tcanal_final as string,\n\t\tCommande as string,\n\t\tno_offre as string,\n\t\t{ATC Performance} as string,\n\t\tcanal as string,\n\t\tRowCount as string,\n\t\tATC as string,\n\t\t{Canal final} as string,\n\t\tcode_postal_atc as string,\n\t\tNomATC as string,\n\t\tMatricule as string,\n\t\tdate_id as string,\n\t\tHubName as string,\n\t\tid_canal_final as string,\n\t\t{qte plateforme final} as string,\n\t\t{ca plateforme final} as string,\n\t\tSum_qt_factur_e as string,\n\t\tSum_ca_factur_ as string,\n\t\tSum_ca_ecoulement as string,\n\t\tSum_qte_ecoulement as string,\n\t\tcode_depot as string,\n\t\tid_canal as string,\n\t\tmarque_code as string,\n\t\t{Document de vente} as string,\n\t\t{Type de facture} as string,\n\t\tClient as string,\n\t\tMarque as string,\n\t\t{ATC Corrig�} as string,\n\t\t{Motif commande} as string,\n\t\t{Org. commerciale} as string,\n\t\tmarque_id as string,\n\t\tOffre as string\n\t),\n\tpartitionFileNames:['TEREVA_ECOUL_PREPARED.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> TEREVAECOULPREPARED\nleftOnly sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\t{Marque DESC} as string,\n\t\t{Marque Code} as string,\n\t\t{Sous Famille} as string,\n\t\t{Référence Article Fournisseur} as string,\n\t\t{Agence Code} as string,\n\t\t{Département ID} as string,\n\t\t{Quantité en UV BL} as string,\n\t\tyearmonth as string,\n\t\tyear as string,\n\t\tmonth as string,\n\t\tPOSid as string,\n\t\tWholeSalerID as string,\n\t\tPOSSAMidString as string,\n\t\tHubSAPid as string,\n\t\tBrandID as string\n\t),\n\tpartitionFileNames:['TEREVA_ORGANISATION_NOTFOUND.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> TEREVAORGANISATIONNOTFOUND\nConditionalSplit1@qteNull sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\t{Marque DESC} as string,\n\t\t{Marque Code} as string,\n\t\t{Sous Famille} as string,\n\t\t{Référence Article Fournisseur} as string,\n\t\t{Agence Code} as string,\n\t\t{Département ID} as string,\n\t\t{Quantité en UV BL} as string,\n\t\tyearmonth as string,\n\t\tyear as string,\n\t\tmonth as string,\n\t\tPOSid as string,\n\t\tWholeSalerID as string,\n\t\tPOSSAMidString as string,\n\t\tHubSAPid as string,\n\t\tBrandID as string\n\t),\n\tpartitionFileNames:['TEREVA_QteNull.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> terevaQteNull"
		}
	}
}