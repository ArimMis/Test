{
	"name": "TEREVA_PREPARATION",
	"properties": {
		"folder": {
			"name": "PREPARATION ECOULEMENT"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "TEREVA_ECOULEMENT_INPUT",
						"type": "DatasetReference"
					},
					"name": "ECOULEMENT"
				},
				{
					"dataset": {
						"referenceName": "TEREVA_ORGANISATION",
						"type": "DatasetReference"
					},
					"name": "organisation"
				},
				{
					"dataset": {
						"referenceName": "VENTES_DIRECTES_PREPARED",
						"type": "DatasetReference"
					},
					"name": "ventesDirectes"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "outTempData",
						"type": "DatasetReference"
					},
					"name": "TEREVAECOULPREPARED"
				},
				{
					"dataset": {
						"referenceName": "outErrorFinding",
						"type": "DatasetReference"
					},
					"name": "TEREVAORGANISATIONNOTFOUND"
				},
				{
					"dataset": {
						"referenceName": "outErrorFinding",
						"type": "DatasetReference"
					},
					"name": "terevaQteNull"
				}
			],
			"transformations": [
				{
					"name": "flowlet1",
					"flowlet": {
						"referenceName": "decrementationVenteDirecte",
						"type": "DataFlowReference"
					}
				},
				{
					"name": "yearmonthANDcanal"
				},
				{
					"name": "yearANDmonth"
				},
				{
					"name": "agenceCodeNotNull"
				},
				{
					"name": "posIDNotNull"
				},
				{
					"name": "innerOrganisation"
				},
				{
					"name": "uniqueOrganisation"
				},
				{
					"name": "innerVentesDirectes"
				},
				{
					"name": "rename"
				},
				{
					"name": "leftVentesDirectes"
				},
				{
					"name": "outerLeftVentesDirectes"
				},
				{
					"name": "dropColumnsInCommon1"
				},
				{
					"name": "dropColumnsInCommon"
				},
				{
					"name": "fullLeftUnion"
				},
				{
					"name": "uniformisation"
				},
				{
					"name": "marquename"
				},
				{
					"name": "fullLeftOrganisation"
				},
				{
					"name": "leftOnly"
				},
				{
					"name": "ConditionalSplit1"
				},
				{
					"name": "EndVentesDirectes"
				},
				{
					"name": "window1"
				},
				{
					"name": "select1"
				},
				{
					"name": "derivedColumn1"
				},
				{
					"name": "idDecrementation"
				},
				{
					"name": "select2"
				},
				{
					"name": "derivedColumn2"
				},
				{
					"name": "join1"
				}
			],
			"script": "source(output(\n\t\tProp_0 as string,\n\t\tsociete as string,\n\t\tregion_lib as string,\n\t\tsgeo as string,\n\t\tsgeo_lib as string,\n\t\tagence as string,\n\t\tagence_lib as string,\n\t\tdep_ag as string,\n\t\tfrs as string,\n\t\tarticle as string,\n\t\tarticle_lib as string,\n\t\tdm as string,\n\t\tref_frs as string,\n\t\t{vva (m) n} as string,\n\t\t{vva (m) n-1} as string,\n\t\t{qte (m) n} as string,\n\t\t{qte (m) n-1} as string,\n\t\t{vva (c) n} as string,\n\t\t{vva (c) n-1} as string,\n\t\t{qte (c) n} as string,\n\t\t{qte (c) n-1} as string,\n\t\t{var. vva (m)} as string,\n\t\t{var. qte (m)} as string,\n\t\t{var. vva (c)} as string,\n\t\t{var. qte (c)} as string,\n\t\tpath as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> ECOULEMENT\nsource(output(\n\t\tWholeSalerID as string,\n\t\tWholeSalerShortName as string,\n\t\tUnitID as string,\n\t\tPOSid as string,\n\t\tPOSdescription as string,\n\t\tCounty as string,\n\t\tPOSSAMid as string,\n\t\tPOSSAMidString as string,\n\t\tSupplierID as string,\n\t\tBrandID as string,\n\t\tWholeSalerHubID as string,\n\t\tHubName as string,\n\t\tHubSAPid as string,\n\t\tSectorID as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> organisation\nsource(output(\n\t\tyear as string,\n\t\treference as string,\n\t\t{Code client} as string,\n\t\tqte_ecoulement as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> ventesDirectes\nderivedColumn2 compose(mapColumn(\n\t\tid = idDecrementation,\n\t\tPossAMid = POSSAMid,\n\t\treference,\n\t\tyear,\n\t\tmonth,\n\t\tqte_ecoulement,\n\t\tqte_venteDirecte = {Qté vente direct}\n\t),\n\tcomposition: 'decrementationVenteDirecte') ~> flowlet1@(output1)\nrename derive(yearmonth = replace(split(split(path, \"/\")[3], \"_\")[1], \"-\", \"\"),\n\t\tcanal = split(split(path, \"/\")[3], \"_\")[2],\n\t\tqte_ecoulement = toDouble(qte_ecoulement)) ~> yearmonthANDcanal\nConditionalSplit1@qteNotNul derive(year = substring(yearmonth, 1, 4),\n\t\tmonth = substring(yearmonth, 5, 2)) ~> yearANDmonth\nyearANDmonth filter(!isNull(agence_code)) ~> agenceCodeNotNull\norganisation filter(!isNull(POSid)) ~> posIDNotNull\nagenceCodeNotNull, uniqueOrganisation join(agence_code == POSid,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> innerOrganisation\nposIDNotNull aggregate(groupBy(POSid,\n\t\tHubSAPid),\n\tWholeSalerID = max(WholeSalerID),\n\t\tWholeSalerShortName = max(WholeSalerShortName),\n\t\tUnitID = max(UnitID),\n\t\tPOSdescription = max(POSdescription),\n\t\tCounty = max(County),\n\t\tPOSSAMid = max(POSSAMid),\n\t\tSupplierID = max(SupplierID),\n\t\tBrandID = max(BrandID),\n\t\tWholeSalerHubID = max(WholeSalerHubID),\n\t\tHubName = max(HubName),\n\t\tSectorID = max(SectorID)) ~> uniqueOrganisation\nwindow1, EndVentesDirectes join(yearANDmonth@year == EndVentesDirectes@year\n\t&& ConditionalSplit1@qteNotNul@reference == EndVentesDirectes@reference\n\t&& POSSAMid == {Code client},\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> innerVentesDirectes\nECOULEMENT select(mapColumn(\n\t\tsociete,\n\t\tregion_lib,\n\t\tsgeo,\n\t\tsgeo_lib,\n\t\tagence_code = agence,\n\t\tagence_lib,\n\t\tdep_ag,\n\t\tmarque_file = frs,\n\t\tarticle_lib,\n\t\tdm,\n\t\treference = ref_frs,\n\t\tqte_ecoulement = {qte (m) n},\n\t\tpath\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> rename\ninnerOrganisation, EndVentesDirectes join(yearANDmonth@year == EndVentesDirectes@year\n\t&& coalesce(toString(toInteger(replace(ConditionalSplit1@qteNotNul@reference, \" \", \"\"))),replace(ConditionalSplit1@qteNotNul@reference, \" \", \"\")) == coalesce(toString(toInteger(replace(EndVentesDirectes@reference, \" \", \"\"))),replace(EndVentesDirectes@reference, \" \", \"\"))\n\t&& POSSAMid == {Code client},\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> leftVentesDirectes\nleftVentesDirectes filter(isNull(EndVentesDirectes@reference) || isNull(EndVentesDirectes@year) || isNull({Code client})) ~> outerLeftVentesDirectes\nderivedColumn1 select(mapColumn(\n\t\tsociete,\n\t\tregion_lib,\n\t\tqte_ecoulement,\n\t\tsgeo,\n\t\tsgeo_lib,\n\t\tagence_code,\n\t\tagence_lib,\n\t\tdep_ag,\n\t\tmarque_file,\n\t\tarticle_lib,\n\t\tdm,\n\t\treference,\n\t\tpath,\n\t\tyearmonth,\n\t\tcanal,\n\t\tyear,\n\t\tmonth,\n\t\tPOSid,\n\t\tHubSAPid,\n\t\tWholeSalerID,\n\t\tWholeSalerShortName,\n\t\tUnitID,\n\t\tPOSdescription,\n\t\tCounty,\n\t\tPOSSAMid,\n\t\tSupplierID,\n\t\tBrandID,\n\t\tWholeSalerHubID,\n\t\tHubName,\n\t\tSectorID\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> dropColumnsInCommon1\nouterLeftVentesDirectes select(mapColumn(\n\t\tsociete,\n\t\tregion_lib,\n\t\tsgeo,\n\t\tsgeo_lib,\n\t\tagence_code,\n\t\tagence_lib,\n\t\tdep_ag,\n\t\tmarque_file,\n\t\tarticle_lib,\n\t\tdm,\n\t\treference = ConditionalSplit1@qteNotNul@reference,\n\t\tqte_ecoulement,\n\t\tpath,\n\t\tyearmonth,\n\t\tcanal,\n\t\tyear = yearANDmonth@year,\n\t\tmonth,\n\t\tPOSid,\n\t\tHubSAPid,\n\t\tWholeSalerID,\n\t\tWholeSalerShortName,\n\t\tUnitID,\n\t\tPOSdescription,\n\t\tCounty,\n\t\tPOSSAMid,\n\t\tSupplierID,\n\t\tBrandID,\n\t\tWholeSalerHubID,\n\t\tHubName,\n\t\tSectorID\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> dropColumnsInCommon\ndropColumnsInCommon1, dropColumnsInCommon union(byName: true)~> fullLeftUnion\nmarquename select(mapColumn(\n\t\tdistributeur = societe,\n\t\tagence_code,\n\t\tmarque_file,\n\t\treference,\n\t\tqte_ecoulement,\n\t\tyearmonth,\n\t\tcanal,\n\t\tyear,\n\t\tmonth,\n\t\tHubSAPid,\n\t\tCounty,\n\t\tPOSSAMid,\n\t\tmarque_id = BrandID\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> uniformisation\nfullLeftUnion derive(marque_name = \"SaunierDuval\",\n\t\tmarque = \"1604\",\n\t\tmarque_num = \"1604\") ~> marquename\nagenceCodeNotNull, uniqueOrganisation join(agence_code == POSid,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> fullLeftOrganisation\nfullLeftOrganisation filter(isNull(POSid)) ~> leftOnly\nyearmonthANDcanal split(qte_ecoulement!=0,\n\tdisjoint: false) ~> ConditionalSplit1@(qteNotNul, qteNull)\nventesDirectes select(mapColumn(\n\t\tyear,\n\t\treference,\n\t\t{Code client},\n\t\t{Qté vente direct} = qte_ecoulement\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> EndVentesDirectes\ninnerOrganisation window(over(year,\n\t\tPOSSAMid,\n\t\treference),\n\tasc(month, true),\n\tqte_cumul = sum(qte_ecoulement)) ~> window1\ninnerVentesDirectes select(mapColumn(\n\t\tsociete,\n\t\tregion_lib,\n\t\tsgeo,\n\t\tsgeo_lib,\n\t\tagence_code,\n\t\tagence_lib,\n\t\tdep_ag,\n\t\tmarque_file,\n\t\tarticle_lib,\n\t\tdm,\n\t\treference = ConditionalSplit1@qteNotNul@reference,\n\t\tqte_ecoulement,\n\t\tpath,\n\t\tyearmonth,\n\t\tcanal,\n\t\tyear = yearANDmonth@year,\n\t\tmonth,\n\t\tPOSid,\n\t\tHubSAPid,\n\t\tWholeSalerID,\n\t\tWholeSalerShortName,\n\t\tUnitID,\n\t\tPOSdescription,\n\t\tCounty,\n\t\tPOSSAMid,\n\t\tSupplierID,\n\t\tBrandID,\n\t\tWholeSalerHubID,\n\t\tHubName,\n\t\tSectorID,\n\t\tqte_cumul,\n\t\treference = EndVentesDirectes@reference,\n\t\t{Code client},\n\t\t{Qté vente direct}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select1\njoin1 derive(qte_ecoulement = qt_final) ~> derivedColumn1\nselect1 keyGenerate(output(idDecrementation as long),\n\tstartAt: 1L,\n\tstepValue: 1L) ~> idDecrementation\nidDecrementation select(mapColumn(\n\t\tidDecrementation,\n\t\tPOSSAMid,\n\t\treference,\n\t\tyear,\n\t\tmonth,\n\t\tqte_ecoulement,\n\t\t{Qté vente direct}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> select2\nselect2 derive(month = toInteger(month),\n\t\tqte_ecoulement = toFloat(qte_ecoulement),\n\t\t{Qté vente direct} = toFloat({Qté vente direct})) ~> derivedColumn2\nidDecrementation, flowlet1@output1 join(idDecrementation == id,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> join1\nuniformisation sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tOrg_commerciale as string,\n\t\t{Canal distribution} as string,\n\t\t{Secteur d'activit�} as string,\n\t\t{Document de vente} as string,\n\t\tPoste as string,\n\t\t{Jour calendaire} as string,\n\t\t{Agence commerciale corrig�} as string,\n\t\t{ATC Corrig�} as string,\n\t\t{Donneur d'ordre} as string,\n\t\t{Recept de march} as string,\n\t\t{Destinataire facture} as string,\n\t\t{Type doc vente} as string,\n\t\t{Type de poste} as string,\n\t\tLivraison as string,\n\t\t{Type de livraison} as string,\n\t\t{Type poste Livraison} as string,\n\t\tFacture as string,\n\t\t{Type de facture} as string,\n\t\t{Type poste Facture} as string,\n\t\t{Mois calendrier} as string,\n\t\t{Ann�e civile} as string,\n\t\t{Motif commande} as string,\n\t\t{CA cd�} as string,\n\t\t{Qt� livr�e} as string,\n\t\t{CA livr�} as string,\n\t\t{Qt� factur�e} as string,\n\t\t{CA factur�} as string,\n\t\t{Cout standard cd�} as string,\n\t\t{Cout fabrication} as string,\n\t\t{Cout standard livr�} as string,\n\t\t{Cout standard factur�} as string,\n\t\tdate_id as string,\n\t\tyear as string,\n\t\tyearmonth as string,\n\t\tqt_cd_e as string,\n\t\tca_cd_ as string,\n\t\tqt_factur_e as string,\n\t\tca_factur_ as string,\n\t\treference as string,\n\t\tWholeSalerID as string,\n\t\tWholeSalerHubID as string,\n\t\tHubName as string,\n\t\t{P�riode} as string,\n\t\tOffre as string,\n\t\tmonth as string,\n\t\tqte_ecoulement as string,\n\t\tPOSSAMidString as string,\n\t\tHubSAPid as string,\n\t\tdistributeur as string,\n\t\tagence_code as string,\n\t\tmarque as string,\n\t\t{Code postal} as string,\n\t\tmarque_name as string,\n\t\tqte_ecc as string,\n\t\tca_ecoulement as string,\n\t\tdata_origin as string,\n\t\t{Ecoulement origin} as string,\n\t\tcanal_final as string,\n\t\t{ATC performance} as string,\n\t\tCanal as string\n\t),\n\tpartitionFileNames:['TEREVA_ECOUL_PREPARED.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> TEREVAECOULPREPARED\nleftOnly sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\t{Marque DESC} as string,\n\t\t{Marque Code} as string,\n\t\t{Sous Famille} as string,\n\t\t{Référence Article Fournisseur} as string,\n\t\t{Agence Code} as string,\n\t\t{Département ID} as string,\n\t\t{Quantité en UV BL} as string,\n\t\tyearmonth as string,\n\t\tyear as string,\n\t\tmonth as string,\n\t\tPOSid as string,\n\t\tWholeSalerID as string,\n\t\tPOSSAMidString as string,\n\t\tHubSAPid as string,\n\t\tBrandID as string\n\t),\n\tpartitionFileNames:['TEREVA_ORGANISATION_NOTFOUND.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> TEREVAORGANISATIONNOTFOUND\nConditionalSplit1@qteNull sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\t{Marque DESC} as string,\n\t\t{Marque Code} as string,\n\t\t{Sous Famille} as string,\n\t\t{Référence Article Fournisseur} as string,\n\t\t{Agence Code} as string,\n\t\t{Département ID} as string,\n\t\t{Quantité en UV BL} as string,\n\t\tyearmonth as string,\n\t\tyear as string,\n\t\tmonth as string,\n\t\tPOSid as string,\n\t\tWholeSalerID as string,\n\t\tPOSSAMidString as string,\n\t\tHubSAPid as string,\n\t\tBrandID as string\n\t),\n\tpartitionFileNames:['TEREVA_QteNull.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> terevaQteNull"
		}
	}
}