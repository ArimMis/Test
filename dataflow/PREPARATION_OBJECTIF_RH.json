{
	"name": "PREPARATION_OBJECTIF_RH",
	"properties": {
		"folder": {
			"name": "RH"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "OBJECTIFS_RH",
						"type": "DatasetReference"
					},
					"name": "objectif"
				},
				{
					"dataset": {
						"referenceName": "REFERENTIEL_LEVIER_RH",
						"type": "DatasetReference"
					},
					"name": "levierPerformance"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "PREPARATION_OBJECTIF_RH",
						"type": "DatasetReference"
					},
					"name": "output"
				}
			],
			"transformations": [
				{
					"name": "newColumn"
				},
				{
					"name": "RecordID"
				},
				{
					"name": "dropColumns"
				},
				{
					"name": "YEARFILTER"
				},
				{
					"name": "splitting"
				},
				{
					"name": "FlattenHierarchie"
				},
				{
					"name": "FlattenMarque"
				},
				{
					"name": "FlattenCanal"
				},
				{
					"name": "lenHierarchie3"
				},
				{
					"name": "innerLevier"
				},
				{
					"name": "levierCA"
				},
				{
					"name": "Pivot1"
				},
				{
					"name": "levierQA"
				},
				{
					"name": "Pivot2"
				},
				{
					"name": "Union2"
				},
				{
					"name": "lenHierarchieNot3"
				},
				{
					"name": "innerLevier2"
				},
				{
					"name": "levierQA2"
				},
				{
					"name": "Pivot3"
				},
				{
					"name": "levierCA2"
				},
				{
					"name": "Pivot4"
				},
				{
					"name": "Union3"
				},
				{
					"name": "Union4"
				},
				{
					"name": "keepColumns"
				},
				{
					"name": "SelectQuantity"
				},
				{
					"name": "quantityToLine"
				},
				{
					"name": "SelectCA"
				},
				{
					"name": "CAtoLine"
				},
				{
					"name": "getQuantityMonth"
				},
				{
					"name": "getCAMonth"
				},
				{
					"name": "joinQuantityAndCA"
				},
				{
					"name": "changeNULL"
				},
				{
					"name": "deleteRightColumn"
				},
				{
					"name": "dataCleansing"
				},
				{
					"name": "uniqueLevier"
				},
				{
					"name": "libelleLevier"
				},
				{
					"name": "Filter1"
				},
				{
					"name": "typeCast"
				},
				{
					"name": "MapDrifted1",
					"description": "Creates an explicit mapping for each drifted column"
				}
			],
			"script": "source(output(\n\t\t{Num Org} as string,\n\t\t{Nom Org} as string,\n\t\t{Nom DR} as string,\n\t\t{Num DR} as string,\n\t\tDR as string,\n\t\t{ATC (ATC- DR)} as string,\n\t\t{ATC (DR-ATC)} as string,\n\t\t{Num ATC} as string,\n\t\t{Nom ATC} as string,\n\t\tDept as string,\n\t\t{Canal Dist} as string,\n\t\t{Nom Canal} as string,\n\t\t{Flux text} as string,\n\t\tHubSAPiD as string,\n\t\t{Activité} as string,\n\t\t{Nom Activité} as string,\n\t\t{Art Niv 1} as string,\n\t\t{Nom Niv 1} as string,\n\t\t{Art Niv 2} as string,\n\t\t{Nom Niv 2} as string,\n\t\t{Art Niv 3} as string,\n\t\t{Nom Niv 3} as string,\n\t\t{Art Niv 4} as string,\n\t\t{Nom Niv 4} as string,\n\t\t{Art Niv 5} as string,\n\t\t{Nom Niv 5} as string,\n\t\t{Nom Niv Combiné} as string,\n\t\t{PMV An} as string,\n\t\t{Qté Obj An} as integer,\n\t\t{CA Obj An} as string,\n\t\t{Qté Mois 01} as string,\n\t\t{Qté Mois 02} as string,\n\t\t{Qté Mois 03} as string,\n\t\t{Qté Mois 04} as string,\n\t\t{Qté Mois 05} as string,\n\t\t{Qté Mois 06} as string,\n\t\t{Qté Mois 07} as string,\n\t\t{Qté Mois 08} as string,\n\t\t{Qté Mois 09} as string,\n\t\t{Qté Mois 10} as string,\n\t\t{Qté Mois 11} as string,\n\t\t{Qté Mois 12} as string,\n\t\t{CA Mois 01} as string,\n\t\t{CA Mois 02} as string,\n\t\t{CA Mois 03} as string,\n\t\t{CA Mois 04} as string,\n\t\t{CA Mois 05} as string,\n\t\t{CA Mois 06} as string,\n\t\t{CA Mois 07} as string,\n\t\t{CA Mois 08} as string,\n\t\t{CA Mois 09} as string,\n\t\t{CA Mois 10} as string,\n\t\t{CA Mois 11} as string,\n\t\t{CA Mois 12} as string,\n\t\t{Qté Trim 1} as string,\n\t\t{Qté Trim 2} as string,\n\t\t{Qté Trim 3} as string,\n\t\t{Qté Trim 4} as string,\n\t\t{CA Trim 1} as string,\n\t\t{CA Trim 2} as string,\n\t\t{CA Trim 3} as string,\n\t\t{CA Trim 4} as string,\n\t\t{Qté Cumul 01} as string,\n\t\t{Qté Cumul 02} as string,\n\t\t{Qté Cumul 03} as string,\n\t\t{Qté Cumul 04} as string,\n\t\t{Qté Cumul 05} as string,\n\t\t{Qté Cumul 06} as string,\n\t\t{Qté Cumul 07} as string,\n\t\t{Qté Cumul 08} as string,\n\t\t{Qté Cumul 09} as string,\n\t\t{Qté Cumul 10} as string,\n\t\t{Qté Cumul 11} as string,\n\t\t{Qté Cumul 12} as string,\n\t\t{CA Cumul 01} as string,\n\t\t{CA Cumul 02} as string,\n\t\t{CA Cumul 03} as string,\n\t\t{CA Cumul 04} as string,\n\t\t{CA Cumul 05} as string,\n\t\t{CA Cumul 06} as string,\n\t\t{CA Cumul 07} as string,\n\t\t{CA Cumul 08} as string,\n\t\t{CA Cumul 09} as string,\n\t\t{CA Cumul 10} as string,\n\t\t{CA Cumul 11} as string,\n\t\t{CA Cumul 12} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinferDriftedColumnTypes: true,\n\tignoreNoFilesFound: false) ~> objectif\nsource(output(\n\t\t{Année} as string,\n\t\tDocumentation as string,\n\t\tMarque as string,\n\t\tCible as string,\n\t\t{Périmètre} as string,\n\t\tLevier as string,\n\t\tCanal as string,\n\t\t{Hiérarchie inclues} as string,\n\t\t{Hiérarchies exclues} as string,\n\t\tType as string,\n\t\t{Valeur Annuelle} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> levierPerformance\nRecordID derive({diffus/chantier} = trim(split(Cible, \" \")[2], \" \"),\n\t\tID_KPI = \"Sum_XRow_\"+toString(RecordID),\n\t\t{Libellé levié} = Levier+\"-\"+Documentation+\" \"+Cible+\" \"+iif({Valeur Annuelle}==\"YES\", \"Annuel\", \"Mensuel\")) ~> newColumn\nuniqueLevier keyGenerate(output(RecordID as long),\n\tstartAt: 1L) ~> RecordID\nnewColumn select(mapColumn(\n\t\t{Année},\n\t\tDocumentation,\n\t\tMarque,\n\t\tCible,\n\t\t{Périmètre},\n\t\tLevier,\n\t\tCanal,\n\t\tHierarchie = {Hiérarchie inclues},\n\t\tType,\n\t\t{Libellé levié},\n\t\t{diffus/chantier},\n\t\tID_KPI,\n\t\t{Valeur Annuelle}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> dropColumns\nlevierPerformance filter({Année}==\"2020\") ~> YEARFILTER\ndropColumns derive(Marque = split(Marque, \".\"),\n\t\tCanal = split(Canal, \",\"),\n\t\tHierarchie = split(Hierarchie, \",\")) ~> splitting\nFlattenCanal foldDown(unroll(Hierarchie),\n\tmapColumn(\n\t\t{Année},\n\t\tDocumentation,\n\t\tMarque,\n\t\tCible,\n\t\t{Périmètre},\n\t\tLevier,\n\t\tCanal,\n\t\tHierarchie,\n\t\tType,\n\t\t{Libellé levié},\n\t\t{diffus/chantier},\n\t\tID_KPI,\n\t\t{Valeur Annuelle}\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> FlattenHierarchie\nsplitting foldDown(unroll(Marque),\n\tmapColumn(\n\t\t{Année},\n\t\tDocumentation,\n\t\tMarque,\n\t\tCible,\n\t\t{Périmètre},\n\t\tLevier,\n\t\tCanal,\n\t\tHierarchie,\n\t\tType,\n\t\t{Libellé levié},\n\t\t{diffus/chantier},\n\t\tID_KPI,\n\t\t{Valeur Annuelle}\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> FlattenMarque\nFlattenMarque foldDown(unroll(Canal),\n\tmapColumn(\n\t\t{Année},\n\t\tDocumentation,\n\t\tMarque,\n\t\tCible,\n\t\t{Périmètre},\n\t\tLevier,\n\t\tCanal,\n\t\tHierarchie,\n\t\tType,\n\t\t{Libellé levié},\n\t\t{diffus/chantier},\n\t\tID_KPI,\n\t\t{Valeur Annuelle}\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> FlattenCanal\ntypeCast filter(length(Hierarchie)==3) ~> lenHierarchie3\ndataCleansing, lenHierarchie3 join({Num Org} == Marque\n\t&& {Canal Dist} == Canal\n\t&& {Nom Canal} == {diffus/chantier}\n\t&& {Art Niv 2} == Hierarchie,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> innerLevier\ninnerLevier filter(Type==\"CA\") ~> levierCA\nlevierCA pivot(groupBy({Num Org},\n\t\t{Num DR},\n\t\t{Num ATC},\n\t\t{Canal Dist},\n\t\t{Nom Canal},\n\t\t{Art Niv 1},\n\t\t{Art Niv 2},\n\t\t{Art Niv 3},\n\t\t{Art Niv 4},\n\t\t{Art Niv 5},\n\t\tMois,\n\t\t{Valeur Annuelle}),\n\tpivotBy(ID_KPI),\n\t{} = sum(toDouble(ca_final)),\n\tcolumnNaming: '$N$V',\n\tlateral: false) ~> Pivot1\ninnerLevier filter(Type==\"Quantité\") ~> levierQA\nlevierQA pivot(groupBy({Num Org},\n\t\t{Num DR},\n\t\t{Num ATC},\n\t\t{Canal Dist},\n\t\t{Nom Canal},\n\t\t{Art Niv 1},\n\t\t{Art Niv 2},\n\t\t{Art Niv 3},\n\t\t{Art Niv 4},\n\t\t{Art Niv 5},\n\t\tMois,\n\t\t{Valeur Annuelle}),\n\tpivotBy(ID_KPI),\n\t{} = sum(toDouble(qt_final)),\n\tcolumnNaming: '$N$V',\n\tlateral: false) ~> Pivot2\nPivot1, Pivot2 union(byName: true)~> Union2\ntypeCast filter(length(Hierarchie)!=3) ~> lenHierarchieNot3\ndataCleansing, lenHierarchieNot3 join({Num Org} == Marque\n\t&& {Canal Dist} == Canal\n\t&& {Nom Canal} == {diffus/chantier}\n\t&& {Art Niv 1} == Hierarchie,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> innerLevier2\ninnerLevier2 filter(Type==\"Quantité\") ~> levierQA2\nlevierQA2 pivot(groupBy({Num Org},\n\t\t{Num DR},\n\t\t{Num ATC},\n\t\t{Canal Dist},\n\t\t{Nom Canal},\n\t\t{Art Niv 1},\n\t\t{Art Niv 2},\n\t\t{Art Niv 3},\n\t\t{Art Niv 4},\n\t\t{Art Niv 5},\n\t\tMois,\n\t\t{Valeur Annuelle}),\n\tpivotBy(ID_KPI),\n\t{} = sum(toDouble(qt_final)),\n\tcolumnNaming: '$N$V',\n\tlateral: false) ~> Pivot3\ninnerLevier2 filter(Type==\"CA\") ~> levierCA2\nlevierCA2 pivot(groupBy({Num Org},\n\t\t{Num DR},\n\t\t{Num ATC},\n\t\t{Canal Dist},\n\t\t{Nom Canal},\n\t\t{Art Niv 1},\n\t\t{Art Niv 2},\n\t\t{Art Niv 3},\n\t\t{Art Niv 4},\n\t\t{Art Niv 5},\n\t\tMois,\n\t\t{Valeur Annuelle}),\n\tpivotBy(ID_KPI),\n\t{} = sum(ca_final),\n\tcolumnNaming: '$N$V',\n\tlateral: false) ~> Pivot4\nPivot3, Pivot4 union(byName: true)~> Union3\nUnion2, Union3 union(byName: true)~> Union4\nchangeNULL select(mapColumn(\n\t\t{Num Org},\n\t\t{Num DR},\n\t\t{Num ATC},\n\t\t{Canal Dist},\n\t\t{Nom Canal},\n\t\t{Art Niv 1},\n\t\t{Art Niv 2},\n\t\t{Art Niv 3},\n\t\t{Art Niv 4},\n\t\t{Art Niv 5},\n\t\t{Qté Obj An},\n\t\t{CA Obj An},\n\t\t{Qté Mois 01},\n\t\t{Qté Mois 02},\n\t\t{Qté Mois 03},\n\t\t{Qté Mois 04},\n\t\t{Qté Mois 05},\n\t\t{Qté Mois 06},\n\t\t{Qté Mois 07},\n\t\t{Qté Mois 08},\n\t\t{Qté Mois 09},\n\t\t{Qté Mois 10},\n\t\t{Qté Mois 11},\n\t\t{Qté Mois 12},\n\t\t{CA Mois 01},\n\t\t{CA Mois 02},\n\t\t{CA Mois 03},\n\t\t{CA Mois 04},\n\t\t{CA Mois 05},\n\t\t{CA Mois 06},\n\t\t{CA Mois 07},\n\t\t{CA Mois 08},\n\t\t{CA Mois 09},\n\t\t{CA Mois 10},\n\t\t{CA Mois 11},\n\t\t{CA Mois 12}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> keepColumns\nkeepColumns select(mapColumn(\n\t\t{Num Org},\n\t\t{Num DR},\n\t\t{Num ATC},\n\t\t{Canal Dist},\n\t\t{Nom Canal},\n\t\t{Art Niv 1},\n\t\t{Art Niv 2},\n\t\t{Art Niv 3},\n\t\t{Art Niv 4},\n\t\t{Art Niv 5},\n\t\t{Qté Obj An},\n\t\t{CA Obj An},\n\t\t{Qté Mois 01},\n\t\t{Qté Mois 02},\n\t\t{Qté Mois 03},\n\t\t{Qté Mois 04},\n\t\t{Qté Mois 05},\n\t\t{Qté Mois 06},\n\t\t{Qté Mois 07},\n\t\t{Qté Mois 08},\n\t\t{Qté Mois 09},\n\t\t{Qté Mois 10},\n\t\t{Qté Mois 11},\n\t\t{Qté Mois 12}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectQuantity\nSelectQuantity unpivot(output(\n\t\tcolumnName as string,\n\t\tqt_final as string\n\t),\n\tungroupBy({Num Org},\n\t\t{Num DR},\n\t\t{Num ATC},\n\t\t{Canal Dist},\n\t\t{Nom Canal},\n\t\t{Art Niv 1},\n\t\t{Art Niv 2},\n\t\t{Art Niv 3},\n\t\t{Art Niv 4},\n\t\t{Art Niv 5},\n\t\t{Qté Obj An},\n\t\t{CA Obj An}),\n\tlateral: false,\n\tignoreNullPivots: false) ~> quantityToLine\nkeepColumns select(mapColumn(\n\t\t{Num Org},\n\t\t{Num DR},\n\t\t{Num ATC},\n\t\t{Canal Dist},\n\t\t{Nom Canal},\n\t\t{Art Niv 1},\n\t\t{Art Niv 2},\n\t\t{Art Niv 3},\n\t\t{Art Niv 4},\n\t\t{Art Niv 5},\n\t\t{Qté Obj An},\n\t\t{CA Obj An},\n\t\t{CA Mois 01},\n\t\t{CA Mois 02},\n\t\t{CA Mois 03},\n\t\t{CA Mois 04},\n\t\t{CA Mois 05},\n\t\t{CA Mois 06},\n\t\t{CA Mois 07},\n\t\t{CA Mois 08},\n\t\t{CA Mois 09},\n\t\t{CA Mois 10},\n\t\t{CA Mois 11},\n\t\t{CA Mois 12}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectCA\nSelectCA unpivot(output(\n\t\tcolumnName as string,\n\t\tca_final as string\n\t),\n\tungroupBy({Num Org},\n\t\t{Num DR},\n\t\t{Num ATC},\n\t\t{Canal Dist},\n\t\t{Nom Canal},\n\t\t{Art Niv 1},\n\t\t{Art Niv 2},\n\t\t{Art Niv 3},\n\t\t{Art Niv 4},\n\t\t{Art Niv 5},\n\t\t{Qté Obj An},\n\t\t{CA Obj An}),\n\tlateral: true,\n\tignoreNullPivots: false) ~> CAtoLine\nquantityToLine derive(Mois = toInteger(split(columnName, \" \")[3]),\n\t\tqt_final = toDouble(qt_final)) ~> getQuantityMonth\nCAtoLine derive(Mois = toInteger(split(columnName, \" \")[3]),\n\t\tca_final = toDouble(ca_final)) ~> getCAMonth\ngetQuantityMonth, getCAMonth join(quantityToLine@{Num Org} == CAtoLine@{Num Org}\n\t&& quantityToLine@{Num DR} == CAtoLine@{Num DR}\n\t&& quantityToLine@{Num ATC} == CAtoLine@{Num ATC}\n\t&& quantityToLine@{Canal Dist} == CAtoLine@{Canal Dist}\n\t&& quantityToLine@{Nom Canal} == CAtoLine@{Nom Canal}\n\t&& quantityToLine@{Art Niv 1} == CAtoLine@{Art Niv 1}\n\t&& quantityToLine@{Art Niv 2} == CAtoLine@{Art Niv 2}\n\t&& quantityToLine@{Art Niv 3} == CAtoLine@{Art Niv 3}\n\t&& quantityToLine@{Art Niv 4} == CAtoLine@{Art Niv 4}\n\t&& quantityToLine@{Art Niv 5} == CAtoLine@{Art Niv 5}\n\t&& getQuantityMonth@Mois == getCAMonth@Mois,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> joinQuantityAndCA\nFilter1 derive({Art Niv 1} = iif(isNull({Art Niv 1}), \" \", {Art Niv 1}),\n\t\t{Art Niv 2} = iif(isNull({Art Niv 2}), \" \", {Art Niv 2}),\n\t\t{Art Niv 3} = iif(isNull({Art Niv 3}), \" \", {Art Niv 3}),\n\t\t{Art Niv 4} = iif(isNull({Art Niv 4}), \" \", {Art Niv 4}),\n\t\t{Art Niv 5} = iif(isNull({Art Niv 5}), \" \", {Art Niv 5})) ~> changeNULL\njoinQuantityAndCA select(mapColumn(\n\t\t{Num Org} = quantityToLine@{Num Org},\n\t\t{Num DR} = quantityToLine@{Num DR},\n\t\t{Num ATC} = quantityToLine@{Num ATC},\n\t\t{Canal Dist} = quantityToLine@{Canal Dist},\n\t\t{Nom Canal} = quantityToLine@{Nom Canal},\n\t\t{Art Niv 1} = quantityToLine@{Art Niv 1},\n\t\t{Art Niv 2} = quantityToLine@{Art Niv 2},\n\t\t{Art Niv 3} = quantityToLine@{Art Niv 3},\n\t\t{Art Niv 4} = quantityToLine@{Art Niv 4},\n\t\t{Art Niv 5} = quantityToLine@{Art Niv 5},\n\t\t{Qté Obj An} = quantityToLine@{Qté Obj An},\n\t\t{CA Obj An} = quantityToLine@{CA Obj An},\n\t\tqt_final,\n\t\tMois = getQuantityMonth@Mois,\n\t\tca_final\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> deleteRightColumn\ndeleteRightColumn derive({Num Org} = toInteger({Num Org}),\n\t\t{Canal Dist} = toInteger({Canal Dist}),\n\t\t{Nom Canal} = replace(lower({Nom Canal}), \" \", \"\"),\n\t\t{Art Niv 1} = replace({Art Niv 1}, \" \", \"\"),\n\t\t{Art Niv 2} = replace({Art Niv 2}, \" \", \"\"),\n\t\t{CA Obj An} = toDouble(replace({CA Obj An}, \",\", \".\"))) ~> dataCleansing\nlibelleLevier aggregate(groupBy({Année},\n\t\tDocumentation,\n\t\tMarque,\n\t\tCible,\n\t\t{Périmètre},\n\t\tLevier,\n\t\tCanal,\n\t\t{Hiérarchie inclues},\n\t\t{Hiérarchies exclues},\n\t\tType,\n\t\t{Valeur Annuelle}),\n\t{Libellé levié} = max({Libellé levié})) ~> uniqueLevier\nYEARFILTER derive({Libellé levié} = Levier+\"-\"+Documentation+\" \"+Cible+\" \"+{Périmètre}+\" \"+iif({Valeur Annuelle}==\"YES\", \"Annuel\", \"Mensuel\")) ~> libelleLevier\nobjectif filter({Num ATC}==\"16400048\") ~> Filter1\nFlattenHierarchie derive(Marque = toInteger(Marque),\n\t\tCanal = toInteger(Canal),\n\t\t{diffus/chantier} = replace({diffus/chantier}, \" \", \"\")) ~> typeCast\nUnion4 derive(Sum_XRow_11 = toDouble(byName('Sum_XRow_11')),\n\t\tSum_XRow_9 = toDouble(byName('Sum_XRow_9')),\n\t\tSum_XRow_2 = toDouble(byName('Sum_XRow_2')),\n\t\tSum_XRow_4 = toDouble(byName('Sum_XRow_4'))) ~> MapDrifted1\nMapDrifted1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tpartitionFileNames:['PREPARATION_OBJECTIF_RH.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> output"
		}
	}
}